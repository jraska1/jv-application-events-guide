<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title></title>
	<meta name="generator" content="LibreOffice 7.2.4.1 (Linux)"/>
	<meta name="created" content="2021-02-07T12:56:50.499538591"/>
	<meta name="changed" content="2021-12-19T10:40:26.989499353"/>
	<style type="text/css">
		h2.cjk { font-family: "Noto Sans CJK SC" }
		h2.ctl { font-family: "Lohit Devanagari" }
		pre.cjk { font-family: "Noto Sans Mono CJK SC", monospace }
		p.sdfootnote { font-size: 10pt; margin-left: 0.24in; text-indent: -0.24in; margin-bottom: 0in }
		h3.cjk { font-family: "Noto Sans CJK SC" }
		h3.ctl { font-family: "Lohit Devanagari" }
		code.cjk { font-family: "Noto Sans Mono CJK SC", monospace }
		a.sdfootnoteanc { font-size: 57% }
	</style>
</head>
<body lang="cs-CZ" dir="ltr"><h1>Události v aplikaci</h1>
<p>V jednom z dřívějších článků zabývajících se službami
v distribuovaných systémech jsem se přiznal, že jsem silným
zastáncem auditních záznamů o běhu aplikací. Auditními záznamy
v tomto smyslu rozumím informace o událostech, které se staly při
běhu aplikace. Takovými záznamy mohu sledovat běžný provoz
aplikace ale také anomálie, které při provozu nastaly.</p>
<p><span lang="cs-CZ">Pokud jste tvůrci aplikací v jazyce </span><span lang="cs-CZ"><b>Java</b></span>
<span lang="cs-CZ">a používáte framework </span><span lang="cs-CZ"><b>Spring</b></span><span lang="cs-CZ">
(v mém případě jeho rozšíření </span><span lang="cs-CZ"><b>Spring
Boot ver. 2.6.1</b></span><span lang="cs-CZ">), pak by se vám mohla
hodit podpora pro vytváření a sledování aplikačních událostí
</span><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#context-functionality-events"><span lang="cs-CZ">Standard
and Custom Events</span></a><span lang="cs-CZ"> </span>zabudovaná
rovnou do jádra framework.</p>
<p>Jako ukázku a případnou motivaci pro jejich použití jsem se
rozhodl napsat následující řádky.</p>
<p>Při prezentaci jednotlivých řešení bych se rád přiblížil
reálnému použití. Proto je výsledkem mého snažení aplikace ve
Spring Boot, která po spuštění představuje jednu instanci
informačního systému. Prezentované funkce jsou obvykle
realizovány formou profilů, takže je možné při spuštění
zapnout pouze tu funkcionalitu, která vás aktuálně zajímá.</p>
<h1>Technický úvod</h1>
<p><span lang="cs-CZ">Všechny zdrojové kódy související s tímto
textem můžete najít na GitHub v projektu
<a href="https://github.com/jraska1/jv-application-events-guide">jraska1/jv-application-events-guide</a>.</span></p>
<p>Články připravuji ve virtualizovaném linuxovém prostředí.
Používám toto, i když na vlastní funkčnost projektu by to
nemělo mít vliv: 
</p>
<ul>
	<li><p>VirtualBox 6.1 jako virtuální prostředí 
	</p>
	<li><p>Fedora 35</p>
	<li><p>OpenJDK 11 z distribuce</p>
	<li><p>Maven 3 z distribuce 
	</p>
</ul>
<p>Pro experimentování s REST rozhraním používám ještě
nástroje pro práci s JSON datovým formátem, přesněji:</p>
<ul>
	<li><p><a href="https://stedolan.github.io/jq/manual/">jq</a> pro
	zobrazení a manipulaci s existujícím JSON daty</p>
	<li><p><a href="https://github.com/jpmens/jo">jo</a> pro generování
	nových JSON dat (jako požadavek na službu)</p>
</ul>
<h2 class="western">Podrobnější informace pro nastavení
testovacího prostředí</h2>
<p>Pro ty z vás, kteří potřebujete pomoc s nastavením prostředí
a spouštěním jednotlivých příkladů, připojuji detailnější
postup.</p>
<p>Ověřte si, že máte dostupné JDK:</p>
<pre class="western">[raska@fedora ~]$ java -version
<font size="1" style="font-size: 8pt">openjdk version &quot;11.0.13&quot; 2021-10-19</font>
<font size="1" style="font-size: 8pt">OpenJDK Runtime Environment 18.9 (build 11.0.13+8)</font>
<font size="1" style="font-size: 8pt">OpenJDK 64-Bit Server VM 18.9 (build 11.0.13+8, mixed mode, sharing)</font></pre><p>
A také nainstalovaný Maven:</p>
<pre class="western">raska@fedora ~]$ mvn -version
<font size="1" style="font-size: 8pt">Apache Maven 3.6.3 (Red Hat 3.6.3-13)</font>
<font size="1" style="font-size: 8pt">Maven home: /usr/share/maven</font>
<font size="1" style="font-size: 8pt">Java version: 11.0.13, vendor: Red Hat, Inc., runtime: /usr/lib/jvm/java-11-openjdk-11.0.13.0.8-2.fc35.x86_64</font>
<font size="1" style="font-size: 8pt">Default locale: en_US, platform encoding: UTF-8</font>
<font size="1" style="font-size: 8pt">OS name: &quot;linux&quot;, version: &quot;5.15.5-200.fc35.x86_64&quot;, arch: &quot;amd64&quot;, family: &quot;unix&quot;</font></pre><p>
Příklady vyvíjím a testuji ve vývojovém prostředí <span style="font-variant: normal"><span style="font-style: normal"><u>IntelliJ
IDEA</u></span></span>. Do tohoto prostředí si můžete stáhnout
projekt rovnou z GitHub a sestavit jej.</p>
<p>Pokud se nechcete zabývat vývojovým prostředím, pak si jej
můžete sestavit z příkazové řádky. 
</p>
<p>Nejjednodušší postup je následující:</p>
<pre class="western">[raska@fedora ~]$ mkdir devel &amp;&amp; cd devel
[raska@fedora devel]$ git clone https://github.com/jraska1/jv-application-events-guide.git
[raska@fedora devel]$ cd jv-application-events-guide/
[raska@fedora jv-application-events-guide]$ mvn package</pre><p>
Spustit aplikaci můžete tak, že zavoláte rovnou sestavený JAR:</p>
<pre class="western" style="margin-bottom: 0.2in">[raska@fedora jv-application-events-guide]$ java -jar target/application-events-guide-1.0.0.jar</pre><h1>
Aplikace</h1>
<p>Jedná se o standardní aplikaci napsanou pro framework Spring
Boot. Její sestavení a základní komponenty jsou popsány v rámci
Maven projektového souboru <i><b>pom.xml</b></i>. 
</p>
<p>Samotná aplikace po svém startu zahrnuje:</p>
<ul>
	<li><p>Webový server <i><b>Tomcat</b></i> včetně podpory pro
	vytváření webových služeb. V mém případě jej budu používat
	pro uživatelský přístup prostřednictvím REST volání.</p>
	<li><p><i><b>H2</b></i><span style="font-variant: normal"> </span><span style="font-variant: normal"><span style="font-style: normal"><span style="font-weight: normal">relační
	databáze s daty primárně ukládanými za běhu v paměti. Tu
	používám pouze při ukázce dlouhodobého ukládání informací
	o událostech do relační databáze.</span></span></span></p>
</ul>
<h2 class="western">Konfigurace aplikace</h2>
<p>Základní konfigurace platná pro každou spuštěnou instanci
aplikace je v souboru <i><b>resources/application.yaml</b></i>. Jedná
se o konfigurační soubor ve formátu YAML, který se načítá jako
první při spuštění aplikace. 
</p>
<p>Takto vypadá základní konfigurační soubor:</p>
<pre class="western"><font color="#080808"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt"><font color="#0033b3">spring</font>:</font></font></font>
<font color="#080808">  <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">profiles</font></font></font><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">:</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">active</font></font></font><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">:</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt"><font color="#0033b3">node</font>:</font></font></font>
<font color="#080808">  <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">name</font></font></font><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">: node01</font></font></font>
<font color="#080808">  <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">id</font></font></font><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">: local:${node.name}</font></font></font></pre><p>
Ve výchozí konfiguraci nemá aplikace přiřazen žádný aktivní
profil. Později uvidíte, že v tomto případě jsou k dispozici
dvě jednoduché aplikační služby dostupné přes REST rozhraní.
Kromě těchto dvou služeb již nic dalšího aplikace neumí, ale i
tak se dá používat.</p>
<p>Parametry <b>node.name</b> a <b>node.id</b> pouze zavádění
identifikační údaje pro pojmenování spuštěné aplikace. Ty se
budou objevovat v odpovědích aplikačních služeb.</p>
<p>Pokud se podíváte do <i><b>resources</b></i> projektu, pak zde
kromě základního konfiguračního souboru aplikace uvidíte také
konfigurační soubory pro jednotlivé profily nazvané
<i><b>application-&lt;název profilu&gt;.yaml</b></i>. Ty Spring Boot
načítá následně pro hlavním konfiguračním souboru pro každý
aktivní profil. Parametry zde nastavené mají přednost před
parametry z hlavního souboru.</p>
<p>Například pro profil listener-couchdb existuje konfigurační
soubor <i><b>application-listener-couchdb.yaml</b></i> s parametry
potřebnými pro připojení na CouchDB:</p>
<pre class="western"><font color="#080808"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt"><font color="#0033b3"><span lang="cs-CZ">couchdb</span></font><span lang="cs-CZ">:</span></font></font></font>
<font color="#080808">  <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">url-base</font></font></font><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">: http://localhost:5984/events</font></font></font>
<font color="#080808">  <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">username</font></font></font><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">: admin</font></font></font>
<font color="#080808">  <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">password</font></font></font><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">: admin</font></font></font></pre><h2 class="western">
Hlavní třída aplikace</h2>
<p>V rámci projektu je pouze jedna třída, která má statickou
metodu <b>main()</b>, a sice <b>Application</b>.</p>
<pre class="western" style="font-weight: normal"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@SpringBootApplication</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">Application </font>{</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">private static final </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">Logger </span></font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">logger </span></i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">= </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">LoggerFactory</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">getLogger</span></i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">(</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">Application</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">class</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">);</span></font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">public static void </span></font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">main</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">(</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">String</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">[] args) {</span></font></font><font size="1" style="font-size: 8pt"><span style="font-weight: normal"> </span></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">SpringApplication</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">run</span></i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">(</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">Application</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">class</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, args);</span></font></font><font size="1" style="font-size: 8pt"><span style="font-weight: normal"> </span></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">}</span></font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@Bean</span></font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">public </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ApplicationRunner </span></font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">applicationRunner</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">(</span></font></font><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@Nullable </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">EventQueueComponent </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">eventQueueComponent, </span></font></font><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@Nullable </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">DelayQueue</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">&lt;</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">DelayedCustomEvent</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">&lt;? </span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">extends </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">CustomEvent</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">&gt;&gt; eventQueue) {</span></font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">return </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">args -&gt; {</span></font></font></font>
<font color="#080808">            <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">logger</span></i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.info(</span></font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">&quot;*** Hello World, greetings from Dwarf ***&quot;</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">);</span></font></font></font>
<font color="#080808">            <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">if </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">(</span></font></font><font color="#851691"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">eventQueueComponent </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">!= </span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">null</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">)</span></font></font></font>
<font color="#080808">                <font color="#851691"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">eventQueueComponent</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.runEventConsumer(</span></font></font><font color="#851691"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">eventQueue</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">);</span></font></font></font>
<font color="#080808">        <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">};</span></font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">}</span></font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Toto je základní rámec pro spuštění aplikace. Po inicializaci
frameworku je ještě zavolána metoda <b>applicationRunner()</b><span style="font-weight: normal">.
V tomto okamžiku se nemusíte zabývat tím, k čemu jsou tam
parametry</span> <i><span style="font-weight: normal">eventQueueComponent</span></i>
<span style="font-weight: normal">a </span><i><span style="font-weight: normal">eventQueue</span></i><span style="font-weight: normal">.
K nim</span> <span style="font-weight: normal">se dostanu v některé
z následujících kapitol. </span>
</p>
<p style="font-weight: normal">Úspěšné spuštění aplikace by
mělo být završeno pozdravem pro celý svět od autora. 
</p>
<h2 class="western">Spuštění jedné instance 
</h2>
<p>Jak jsem uvedl již dříve, mám pouze jednu aplikaci, kterou
chci spouštět s různými rolemi. Na to používám samostatný
terminál pro každou instanci. Jako parametr spuštění se zadávají
názvy aktivních profilů, které má aplikace spustit.</p>
<p>Tak například, spuštění instance s profily <b>listener-simple</b>
a <b>event-checker</b> se provede následovně:</p>
<pre class="western">[raska@fedora jv-application-events-guide]$ java -jar target/application-events-guide-1.0.0.jar --spring.profiles.active=listener-simple,event-checker

  <font size="1" style="font-size: 8pt">.   ____          _            __ _ _</font>
 <font size="1" style="font-size: 8pt">/\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</font>
<font size="1" style="font-size: 8pt">( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</font>
 <font size="1" style="font-size: 8pt">\\/  ___)| |_)| | | | | || (_| |  ) ) ) )</font>
  <font size="1" style="font-size: 8pt">'  |____| .__|_| |_|_| |_\__, | / / / /</font>
 <font size="1" style="font-size: 8pt">=========|_|==============|___/=/_/_/_/</font>
<font color="#26a269"> <font size="1" style="font-size: 8pt">:: Spring Boot :: </font>               (v2.6.1)</font>

<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:27.431 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">cz.dsw.app_events_guide.Application     </font> : Starting Application v1.0.0 using Java 11.0.13 on fedora with PID 3151 (/home/raska/IdeaProjects/jv-application-events-guide/target/application-events-guide-1.0.0.jar started by raska in /home/raska/IdeaProjects/jv-application-events-guide)</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:27.434 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">cz.dsw.app_events_guide.Application     </font> : The following profiles are active: listener-simple,event-checker</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:28.717 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">.s.d.r.c.RepositoryConfigurationDelegate</font> : Bootstrapping Spring Data JPA repositories in DEFAULT mode.</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:28.795 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">.s.d.r.c.RepositoryConfigurationDelegate</font> : Finished Spring Data repository scanning in 31 ms. Found 0 JPA repository interfaces.</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:29.612 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">o.s.b.w.embedded.tomcat.TomcatWebServer </font> : Tomcat initialized with port(s): 8080 (http)</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:29.632 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">o.apache.catalina.core.StandardService  </font> : Starting service [Tomcat]</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:29.632 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">org.apache.catalina.core.StandardEngine </font> : Starting Servlet engine: [Apache Tomcat/9.0.55]</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:29.746 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">o.a.c.c.C.[Tomcat].[localhost].[/]      </font> : Initializing Spring embedded WebApplicationContext</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:29.747 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">w.s.c.ServletWebServerApplicationContext</font> : Root WebApplicationContext: initialization completed in 2176 ms</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:30.060 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">com.zaxxer.hikari.HikariDataSource      </font> : HikariPool-1 - Starting...</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:30.466 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">com.zaxxer.hikari.HikariDataSource      </font> : HikariPool-1 - Start completed.</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:30.579 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">o.hibernate.jpa.internal.util.LogHelper </font> : HHH000204: Processing PersistenceUnitInfo [name: default]</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:30.721 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">org.hibernate.Version                   </font> : HHH000412: Hibernate ORM core version 5.6.1.Final</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:31.009 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">o.hibernate.annotations.common.Version  </font> : HCANN000001: Hibernate Commons Annotations {5.1.2.Final}</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:31.196 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">org.hibernate.dialect.Dialect           </font> : HHH000400: Using dialect: org.hibernate.dialect.H2Dialect</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:32.104 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">o.h.e.t.j.p.i.JtaPlatformInitiator      </font> : HHH000490: Using JtaPlatform implementation: [org.hibernate.engine.transaction.jta.platform.internal.NoJtaPlatform]</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:32.114 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">j.LocalContainerEntityManagerFactoryBean</font> : Initialized JPA EntityManagerFactory for persistence unit 'default'</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:32.250 </font><font color="#a2734c"> WARN</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">JpaBaseConfiguration$JpaWebConfiguration</font> : spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:32.729 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">o.s.b.w.embedded.tomcat.TomcatWebServer </font> : Tomcat started on port(s): 8080 (http) with context path ''</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-03 17:52:32.795 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3151</font> --- [           main] <font color="#2aa1b3">cz.dsw.app_events_guide.Application     </font> : Started Application in 6.576 seconds (JVM running for 7.41)</font>
<font color="#aaaaaa"><font size="1" style="font-size: 8pt">2021-12-03 17:52:32.798 </font></font><font color="#26a269"> </font><font color="#26a269"><font size="1" style="font-size: 8pt">INFO</font></font> <font color="#a347ba"><font size="1" style="font-size: 8pt">3151</font></font> <font size="1" style="font-size: 8pt">--- [           main] </font><font color="#2aa1b3"><font size="1" style="font-size: 8pt">cz.dsw.app_events_guide.Application     </font></font> <font size="1" style="font-size: 8pt">: *** Hello World, greetings from Dwarf ***</font></pre><h2 class="western">
Zastavení instance</h2>
<p>Vzhledem k tomu, že mám každou instanci spuštěnou v
samostatném terminálu, pro zastavení postačuje <b>Ctrl-C</b>.</p>
<h1>Služby</h1>
<p>Na tomto místě jsem převzal jako příklady služeb to, co jsem
používal již v dřívějších povídáních o distribuovaných
systémech.</p>
<p>Ono zase o obsah těch služeb v podstatě nejde. Jsou to jen
jednoduché příklady, které je potřeba v reálné situaci
nahradit pro vás užitečným kódem. Ale jako základ, aby se něco
dělo, to bude postačovat.</p>
<p>Mám vytvořené dvě služby <b>serviceA</b> a <b>serviceB</b>,
které obě fungují na principu požadavek – odpověď. 
</p>
<p>Pro každou službu mám tedy vytvořenu dvojici specializovaných
tříd představující požadavek a k němu odpovídající odpověď.
Všechny třídy jsou odvozeny od jednoho společného předka, a tím
je třída <b>Token</b>.</p>
<p>Dědičný vztah tříd a jejich odpovídající vazby na služby
budou asi nejlépe vidět na diagramu: <img src="image/ApplicationEventsGuide-ServiceEntity.jpg" name="Image1" align="left" width="438" height="360" border="0"/>
<br clear="left"/>

</p>
<p>Jediným společným předkem pro všechny typy vyměňovaných
zpráv je abstraktní třída <span style="font-variant: normal"><span style="font-style: normal"><b>Token</b></span></span>.
Atributy definované v rámci této třídy mají následující
význam:</p>
<ul>
	<li><p>nid [URI] – technický identifikátor instance uzlu;
	používá se pro jednoznačnou identifikaci původce zprávy</p>
	<li><p>name [String] – uživatelsky čitelný název instance
	uzlu; nemusí být nutně jednoznačný, neboť se nepoužívá pro
	identifikaci</p>
	<li><p>tid [URI] – jednoznačný identifikátor transakce; v
	případě komunikace typu request/response slouží k provázání
	žádosti s odpověďmi</p>
	<li><p>ts [Date] – časová značka vzniku zprávy</p>
</ul>
<p>Dále mám definovány další následovníky:</p>
<ul>
	<li><p>Request (abstraktní) – předek pro všechny typy zpráv
	vystupující jako dotaz v synchronní komunikaci typu
	požadavek/odpověď</p>
	<li><p>Response - předek pro typy zpráv vystupující jako odpověď
	na dotaz v synchronní komunikaci typu požadavek/odpověď</p>
	<ul>
		<li><p>code [ResponseCodeType] – návratový kód odpovědi</p>
	</ul>
</ul>
<p>No a nakonec jsou zde konkrétní třídy dotazů a odpovědí pro
služby serviceA a serviceB:</p>
<ul>
	<li><p>RequestA – požadavek na službu A</p>
	<li><p>RequestB – požadavek na službu B</p>
	<li><p>ResponseA – výsledek služby A</p>
	<li><p>ResponseB – výsledek služby B</p>
</ul>
<p>Všechny definice tříd implementujících předávané zprávy
jsou součástí package <span style="font-variant: normal"><span style="font-style: normal"><b>entity</b></span></span>.</p>
<h2 class="western">Definice služeb</h2>
<p>Jako společnou definici služeb mám vytvořeno rozhraní
<span style="text-decoration: none"><b>component/ServiceProvider</b></span>:</p>
<pre class="western"><font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public interface </font><font color="#000000">ServiceProvider </font>&lt;<font color="#007e8a">R </font><font color="#0033b3">extends </font><font color="#000000">Request</font>, <font color="#007e8a">T </font><font color="#0033b3">extends </font><font color="#000000">Response</font>&gt; {</font></font></font>

<font color="#080808">    <font color="#007e8a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">T </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">perform</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#007e8a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">R </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">request);</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">default </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getInstanceName</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() { </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Provider&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">; }</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Obsahuje jednu výkonnou metodu, jejíž vstupem je požadavek
odvozený od třídy Request. Výstupem je pak výsledek odvozený od
třídy Response.</p>
<p>Dále je tam ještě metoda poskytující jméno konkrétní
instance. To se mně bude hodit při rozlišování, u jakého
poskytovatele vznikla událost.</p>
<h2 class="western">Implementace služeb</h2>
<p>V package <b>component</b> <span style="font-weight: normal">mám
dvě implementace služeb, </span><b>serviceA</b> <span style="font-weight: normal">a
</span><b>serviceB</b><span style="font-weight: normal">. Obě jsou
anotovány jako </span><b>@Service</b><span style="font-weight: normal">,
takže pro startu aplikace budu mít v kontextu k dispozici jejich
instance.</span></p>
<p><span style="font-weight: normal">Takto vypadá implementace
</span><b>ServiceProviderA</b><span style="font-weight: normal">:</span></p>
<pre class="western" style="font-weight: normal"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Service</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">ServiceProviderA </font><font color="#0033b3">implements </font><font color="#000000">ServiceProvider</font>&lt;<font color="#000000">RequestA</font>, <font color="#000000">ResponseA</font>&gt; {</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@Autowired </span></font></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">private </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">TokenFactory </span></font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">factory</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">;</span></font></font></font>
<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@Autowired </span></font></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">private </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ApplicationEventPublisher </span></font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">publisher</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">;</span></font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@Override</span></font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">public </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ResponseA </span></font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">perform</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">(</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">RequestA </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">request) {</span></font></font></font>

<font color="#080808">        <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">publisher</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.publishEvent(</span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">new </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ProviderEvent(</span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">this</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ProviderEvent</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">Phase</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">ASKED</span></i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, request));</span></font></font></font>

<font color="#080808">        <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ResponseA response </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">= </span></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">factory</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.tokenInstance(request.getTid(), </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ResponseA</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">class</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">);</span></font></font></font>
<font color="#080808">        <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">response</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.setCode(</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ResponseCodeType</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">OK</span></i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">);</span></font></font></font>
<font color="#080808">        <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">response</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.setResult(request.getValue() + </span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">new </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">Random().nextInt((</span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">int</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">) </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">Math</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">max</span></i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">(request.getValue() / </span></font></font><font color="#1750eb"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">2</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, </span></font></font><font color="#1750eb"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">10</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">)));</span></font></font></font>

<font color="#080808">        <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">publisher</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.publishEvent(</span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">new </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ProviderEvent(</span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">this</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ProviderEvent</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">Phase</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">ANSWERED</span></i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, request, </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">response</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">));</span></font></font></font>

<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">return </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">response</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">;</span></font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">}</span></font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@Override</span></font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">public </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">String </span></font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">getInstanceName</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">() { </span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">return </span></font></font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">&quot;Provider A&quot;</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">; }</span></font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
<span style="font-weight: normal">A takto implementace
</span><b>ServiceProviderB</b><span style="font-weight: normal">:</span></p>
<pre class="western" style="font-weight: normal"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Service</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">ServiceProviderB </font><font color="#0033b3">implements </font><font color="#000000">ServiceProvider</font>&lt;<font color="#000000">RequestB</font>, <font color="#000000">ResponseB</font>&gt; {</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@Autowired </span></font></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">private </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">TokenFactory </span></font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">factory</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">;</span></font></font></font>
<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@Autowired </span></font></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">private </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ApplicationEventPublisher </span></font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">publisher</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">;</span></font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@Override</span></font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">public </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ResponseB </span></font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">perform</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">(</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">RequestB </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">request) {</span></font></font></font>

<font color="#080808">        <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">publisher</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.publishEvent(</span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">new </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ProviderEvent(</span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">this</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ProviderEvent</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">Phase</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">ASKED</span></i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, request));</span></font></font></font>

<font color="#080808">        <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ResponseB response </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">= </span></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">factory</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.tokenInstance(request.getTid(), </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ResponseB</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">class</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">);</span></font></font></font>
<font color="#080808">        <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">response</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.setCode(</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ResponseCodeType</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">OK</span></i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">);</span></font></font></font>
<font color="#080808">        <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">response</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.setText(</span></font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">&quot;text length: &quot; </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">+ request.getText().length());</span></font></font></font>

<font color="#080808">        <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">publisher</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.publishEvent(</span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">new </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ProviderEvent(</span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">this</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ProviderEvent</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">Phase</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">ANSWERED</span></i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, request, </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">response</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">));</span></font></font></font>

<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">return </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">response</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">;</span></font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">}</span></font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@Override</span></font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">public </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">String </span></font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">getInstanceName</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">() {</span></font></font><span style="font-weight: normal"> </span><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">return </span></font></font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">&quot;Provider B&quot;</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">;</span></font></font><span style="font-weight: normal"> </span><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">}</span></font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p style="font-weight: normal">
Obě implementace jsou triviální. Vytvoří nový token jako
odpověď, nastaví návratový kód a nakonec nějaký výsledek na
základě dat z požadavku.</p>
<p><span style="font-weight: normal">To, co je skutečně zajímavé,
je instance </span><b>ApplicationEventPublisher</b> <span style="font-weight: normal">a
na ní volaná metoda </span><b>publishEvent()</b><span style="font-weight: normal">.
Ale na ty se podívám až v následujících</span> <span style="font-weight: normal">kapitolách.</span></p>
<h2 class="western">REST rozhraní služeb</h2>
<p style="font-weight: normal">Implementace služby mně nestačí.
Potřebuji se k ní nějak dostat zvenčí aplikace<a class="sdfootnoteanc" name="sdfootnote1anc" href="#sdfootnote1sym"><sup>1</sup></a>.
</p>
<p style="font-weight: normal">Pro tento případ jsem vytvořil
jednoduché REST rozhraní, pro každou službu samostatné URL. 
</p>
<p style="font-weight: normal">Vstupem REST rozhraní služby je
požadavek ve formě JSON objektu. Výsledek je pak opět JSON objekt
odeslaný žadateli na výstupu rozhraní.</p>
<p><span style="font-weight: normal">Rozhraní je implementován</span><span style="font-weight: normal">o</span><span style="font-weight: normal">
třídou </span><b>ProviderController</b> <span style="font-weight: normal">v
package </span><b>rest</b><span style="font-weight: normal">.</span></p>
<pre class="western" style="font-weight: normal"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@RestController</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">ProviderController </font>{</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@Autowired </span></font></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">private </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ServiceProvider</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">&lt;</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">RequestA</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ResponseA</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">&gt; </span></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">providerA</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">;</span></font></font></font>
<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@Autowired </span></font></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">private </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ServiceProvider</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">&lt;</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">RequestB</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ResponseB</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">&gt; </span></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">providerB</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">;</span></font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@RequestMapping</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">(value = </span></font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">&quot;/rest/serviceA&quot;</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, method = {</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">RequestMethod</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">GET</span></i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">RequestMethod</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">POST</span></i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">})</span></font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">public </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ResponseA </span></font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">restProviderA</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">(</span></font></font><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@RequestBody </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">RequestA </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">request) {</span></font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">return </span></font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">providerA</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.perform(request);</span></font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">}</span></font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@RequestMapping</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">(value = </span></font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">&quot;/rest/serviceB&quot;</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, method = {</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">RequestMethod</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">GET</span></i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">RequestMethod</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">POST</span></i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">})</span></font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">public </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ResponseB </span></font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">restProviderB</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">(</span></font></font><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@RequestBody </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">RequestB </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">request) {</span></font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">return </span></font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">providerB</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.perform(request);</span></font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">}</span></font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p style="font-weight: normal">
Implementace je skutečně jednoduchá, většinu práce při
konverzi JSON objektu na Java Bean a zpět provede Spring framework
sám. Pro toto povídání je podstatné injektování instancí
poskytovatelů služby ze Spring kontextu.</p>
<p><span style="font-weight: normal">Služby jsou dostupné na URL
</span><i><span style="font-weight: normal">/rest/serviceA</span></i>
<span style="font-weight: normal">resp. </span><i><span style="font-weight: normal">/rest/serviceB</span></i><span style="font-weight: normal">.
Nezapomeňte, že při vyvolání služby musí být nastavena HTTP
hlavička </span><i><span style="font-weight: normal">Content-Type:
application/json</span></i><span style="font-variant: normal"><span style="font-style: normal"><span style="font-weight: normal">,
aby rozhraní poznalo, že na vstupu je ten správný obsah.</span></span></span></p>
<h2 class="western">Ověření funkce služeb</h2>
<p style="font-weight: normal">Teď již máme vše, abychom mohli
služby vyzkoušet. 
</p>
<p style="font-weight: normal">Nejjednodušší cesta je použití
řádkového příkazu <b>curl</b> pro vytvoření HTTP dotazu.</p>
<p>Nejdříve potřebujeme spustit instanci aplikace. Bude nám
postačovat default profil, takže v samostatném terminálu:</p>
<pre class="western" style="margin-bottom: 0.2in">[raska@fedora jv-application-events-guide]$ java -jar target/application-events-guide-1.0.0.jar</pre><p>
Měla by se vám rozběhnout aplikace a zůstat aktivní.</p>
<p>Dále ve druhém terminálu zkusím vyvolat službu A:</p>
<pre class="western">[raska@fedora ~]$ jo -p nid=local:node02 name=node02 tid=${RANDOM} value=20 | curl -s -X GET --data-binary @- -H &quot;Content-type: application/json&quot; http://localhost:8080/rest/serviceA | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;nid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;local:node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;name&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;8085&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ts&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2021-12-05T10:36:40.371+00:00&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;code&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;OK&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;result&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">24</font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><p>
Nejdříve jsem si vytvořil JSON objekt dotazu pomocí příkazu <b>jo</b>
<span style="font-weight: normal">a poslal jej na standardní výstup</span>.
Dále jsem v rouře zavolal curl s požadavkem na standardním vstupu
(to je ten parametr -d), nastavenou hlavičkou <i>Content-Type</i> a
odpovídajícím URL. Výsledek je naformátován pomocí příkazu
<b>jq</b> (to je jen pro přehlednější zobrazení).</p>
<p>Pokud si nejste jisti, co vytvořil příkaz <b>jo</b>, pak si to
můžete ověřit:</p>
<pre class="western">[raska@fedora ~]$ jo -p nid=local:node02 name=node02 tid=${RANDOM} value=20 | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;nid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;local:node02&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;name&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;node02&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">16950</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;value&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">20</font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><p>
A stejným postupem si můžu vyzkoušet službu B:</p>
<pre class="western">[raska@fedora ~]$ jo -p nid=local:node03 name=node03 tid=$RANDOM text=blablabla | curl -s -X GET --data-binary @- -H &quot;Content-type: application/json&quot; http://localhost:8080/rest/serviceB | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;nid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;local:node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;name&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;5073&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ts&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2021-12-05T10:45:07.248+00:00&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;code&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;OK&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;text&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;text length: 9&quot;</font></font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><h2 class="western">
Klient pro vyvolání služeb</h2>
<p>V předchozím kapitole jsem volal služby příkazem z
příkazového řádku. 
</p>
<p>Pro testování by se ale někdy mohlo hodit, abych měl nějakého
klienta, který sám bude dráždit rozhraní a vytvářet události.
Takže jsem jednoho takového udělal. Dá se spustit s profilem
<i><b>applicant</b></i>.</p>
<p>Takto vypadá specifický konfigurační soubor pro tuto roli
<i>application-applicant.yaml</i>:</p>
<pre class="western"><font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">spring</font>:</font></font></font>
<font color="#080808">  <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">main</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">:</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">web-application-type</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">: NONE</font></font></font>

<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">node</font>:</font></font></font>
<font color="#080808">  <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">name</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">: node09</font></font></font>
<font color="#080808">  <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">id</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">: local:${node.name}</font></font></font>

<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">applicant</font>:</font></font></font>
<font color="#080808">  <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">resource-base</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">: http://localhost:8080/rest</font></font></font></pre><p>
Pokud budu spouštět aplikaci s tímto profilem, pak nebudu chtít,
aby mně běžel HTTP server (instance nebude plnit roli serveru).
Proto je zde nastaven parametr <i>spring.main.web-application-type</i>
na hodnotu <i>NONE</i>. 
</p>
<p>Dále je v konfiguraci nastaveno pojmenování spuštěné
instance v parametru <i>node.name</i>.</p>
<p>Nakonec vidíte, že konfigurace obsahuje základní URL pro
přístup k REST rozhraní služeb, což je parametr
<i>applicant.resource-base</i>. 
</p>
<p>Implementace klienta je ve třídě <b>component/ServiceApplicant</b>:</p>
<pre class="western"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Service</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#9e880d">@Profile</font>(<font color="#067d17">&quot;applicant&quot;</font>)</font></font></font>
<font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@EnableScheduling</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">ServiceApplicant </font>{</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private static final </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Logger </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger </i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">LoggerFactory</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>getLogger</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ServiceApplicant</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">class</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private final </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">RestTemplate </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">restTemplate</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private static final </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Random </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>rand </i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Random();</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Value</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;${applicant.resource-base}&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">) </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">resourceBase</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Autowired </font></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">TokenFactory </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">factory</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Autowired </font></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicationEventPublisher </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">publisher</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ServiceApplicant</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">RestTemplateBuilder </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">restTemplateBuilder) {</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">restTemplate </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= restTemplateBuilder.build();</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Async</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Scheduled</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(fixedRate = </font></font><font color="#1750eb"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">1000</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">executeApplicant</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() {</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">if </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>rand</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.nextBoolean()) {</font></font></font>
<font color="#080808">            <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">RequestA request </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">factory</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.tokenInstance(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">RequestA</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">class</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">            <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">request</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.setValue(</font></font><font color="#1750eb"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">12345</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>

<font color="#080808">            <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">publisher</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.publishEvent(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicantEvent(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicantEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Phase</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>REQUESTED</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">request</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">));</font></font></font>

<font color="#080808">            <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ResponseEntity</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ResponseA</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&gt; </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">restTemplate</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.postForEntity(</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">resourceBase </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">+ </font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;/serviceA&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">request</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ResponseA</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">class</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">            <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">if </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getStatusCode() == </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">HttpStatus</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>OK </i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&amp;&amp; </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getBody() != </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">null</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">) {</font></font></font>
<font color="#080808">                <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.info(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Response from service A: {}&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getBody().getResult());</font></font></font>
<font color="#080808">                <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">publisher</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.publishEvent(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicantEvent(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicantEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Phase</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>RECEIVED</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">request</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getBody()));</font></font></font>
<font color="#080808">            <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">        <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">else </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">{</font></font></font>
<font color="#080808">            <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">RequestB request </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">factory</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.tokenInstance(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">RequestB</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">class</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">            <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">request</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.setText(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Haf haf haf&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>

<font color="#080808">            <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">publisher</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.publishEvent(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicantEvent(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicantEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Phase</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>REQUESTED</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">request</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">));</font></font></font>

<font color="#080808">            <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ResponseEntity</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ResponseB</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&gt; </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">restTemplate</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.postForEntity(</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">resourceBase </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">+ </font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;/serviceB&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">request</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ResponseB</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">class</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">            <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">if </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getStatusCode() == </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">HttpStatus</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>OK </i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&amp;&amp; </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getBody() != </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">null</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">) {</font></font></font>
<font color="#080808">                <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.info(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Response from service B: {}&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getBody().getText());</font></font></font>
<font color="#080808">                <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">publisher</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.publishEvent(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicantEvent(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicantEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Phase</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>RECEIVED</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">request</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getBody()));</font></font></font>
<font color="#080808">            <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">        <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Třída má povoleno plánování pomocí anotace <i>@EnableScheduling</i><span style="font-variant: normal"><span style="font-style: normal">,
což potřebuji k opakovanému spouštění metody </span></span><i>executeApplicant()
</i><span style="font-variant: normal"><span style="font-style: normal">jednou
za sekundu.</span></span></p>
<p style="font-variant: normal; font-style: normal">Metoda náhodně
zvolí, zda bude volat službu A nebo B. Dále pak vytvoří
požadavek na službu, který odešle do REST rozhraní. 
</p>
<p style="font-variant: normal; font-style: normal">O výsledku
referuje zápisem do logu.</p>
<p><span style="font-variant: normal"><span style="font-style: normal">Vyvolání
požadavku na službu a její výsledek je avizován publikování
aplikační události, metodou
</span></span><i>ApplicationEventPublisher.publishEven()</i><span style="font-variant: normal"><span style="font-style: normal">.
Tou se ale budu zabývat v dalších kapitolách.</span></span></p>
<p>Ověřit funkci služeb s klientem si mohu takto:</p>
<p>Nejdříve si spustím server v samostatném terminálu (ukázka
již byla dříve).</p>
<p>V jiném terminálu si spustím klienta:</p>
<pre class="western">[raska@fedora jv-application-events-guide]$ java -jar target/application-events-guide-1.0.0.jar --spring.profiles.active=applicant

  <font size="1" style="font-size: 8pt">.   ____          _            __ _ _</font>
 <font size="1" style="font-size: 8pt">/\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</font>
<font size="1" style="font-size: 8pt">( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</font>
 <font size="1" style="font-size: 8pt">\\/  ___)| |_)| | | | | || (_| |  ) ) ) )</font>
  <font size="1" style="font-size: 8pt">'  |____| .__|_| |_|_| |_\__, | / / / /</font>
 <font size="1" style="font-size: 8pt">=========|_|==============|___/=/_/_/_/</font>
<font color="#26a269"> <font size="1" style="font-size: 8pt">:: Spring Boot :: </font>               (v2.6.1)</font>

<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:43.727 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [           main] <font color="#2aa1b3">cz.dsw.app_events_guide.Application     </font> : Starting Application v1.0.0 using Java 11.0.13 on fedora with PID 7618 (/home/raska/IdeaProjects/jv-application-events-guide/target/application-events-guide-1.0.0.jar started by raska in /home/raska/IdeaProjects/jv-application-events-guide)</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:43.736 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [           main] <font color="#2aa1b3">cz.dsw.app_events_guide.Application     </font> : The following profiles are active: applicant</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:44.919 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [           main] <font color="#2aa1b3">.s.d.r.c.RepositoryConfigurationDelegate</font> : Bootstrapping Spring Data JPA repositories in DEFAULT mode.</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:45.014 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [           main] <font color="#2aa1b3">.s.d.r.c.RepositoryConfigurationDelegate</font> : Finished Spring Data repository scanning in 55 ms. Found 0 JPA repository interfaces.</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:45.919 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [           main] <font color="#2aa1b3">com.zaxxer.hikari.HikariDataSource      </font> : HikariPool-1 - Starting...</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:46.271 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [           main] <font color="#2aa1b3">com.zaxxer.hikari.HikariDataSource      </font> : HikariPool-1 - Start completed.</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:46.404 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [           main] <font color="#2aa1b3">o.hibernate.jpa.internal.util.LogHelper </font> : HHH000204: Processing PersistenceUnitInfo [name: default]</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:46.534 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [           main] <font color="#2aa1b3">org.hibernate.Version                   </font> : HHH000412: Hibernate ORM core version 5.6.1.Final</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:46.810 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [           main] <font color="#2aa1b3">o.hibernate.annotations.common.Version  </font> : HCANN000001: Hibernate Commons Annotations {5.1.2.Final}</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:47.058 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [           main] <font color="#2aa1b3">org.hibernate.dialect.Dialect           </font> : HHH000400: Using dialect: org.hibernate.dialect.H2Dialect</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:48.080 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [           main] <font color="#2aa1b3">o.h.e.t.j.p.i.JtaPlatformInitiator      </font> : HHH000490: Using JtaPlatform implementation: [org.hibernate.engine.transaction.jta.platform.internal.NoJtaPlatform]</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:48.094 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [           main] <font color="#2aa1b3">j.LocalContainerEntityManagerFactoryBean</font> : Initialized JPA EntityManagerFactory for persistence unit 'default'</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:48.499 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [           main] <font color="#2aa1b3">cz.dsw.app_events_guide.Application     </font> : Started Application in 6.188 seconds (JVM running for 7.104)</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:48.508 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [           main] <font color="#2aa1b3">cz.dsw.app_events_guide.Application     </font> : *** Hello World, greetings from Dwarf ***</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:48.803 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [   scheduling-1] <font color="#2aa1b3">c.d.a.component.ServiceApplicant        </font> : Response from service A: 12597</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:49.516 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [   scheduling-1] <font color="#2aa1b3">c.d.a.component.ServiceApplicant        </font> : Response from service A: 14361</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:50.504 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [   scheduling-1] <font color="#2aa1b3">c.d.a.component.ServiceApplicant        </font> : Response from service B: text length: 11</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:51.503 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [   scheduling-1] <font color="#2aa1b3">c.d.a.component.ServiceApplicant        </font> : Response from service A: 13032</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:52.524 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [   scheduling-1] <font color="#2aa1b3">c.d.a.component.ServiceApplicant        </font> : Response from service A: 17072</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:53.504 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [   scheduling-1] <font color="#2aa1b3">c.d.a.component.ServiceApplicant        </font> : Response from service B: text length: 11</font>
<font size="1" style="font-size: 8pt">^C2021-12-05 12:53:54.432 <font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [ionShutdownHook] <font color="#2aa1b3">j.LocalContainerEntityManagerFactoryBean</font> : Closing JPA EntityManagerFactory for persistence unit 'default'</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:54.433 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [ionShutdownHook] <font color="#2aa1b3">.SchemaDropperImpl$DelayedDropActionImpl</font> : HHH000477: Starting delayed evictData of schema as part of SessionFactory shut-down'</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:54.488 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [ionShutdownHook] <font color="#2aa1b3">com.zaxxer.hikari.HikariDataSource      </font> : HikariPool-1 - Shutdown initiated...</font>
<font size="1" style="font-size: 8pt"><font color="#0a0d0e">2021-12-05 12:53:54.499 </font><font color="#26a269"> INFO</font> <font color="#a347ba">7618</font> --- [ionShutdownHook] <font color="#2aa1b3">com.zaxxer.hikari.HikariDataSource      </font> : HikariPool-1 - Shutdown completed.</font></pre><p>
<br/>
<br/>

</p>
<p>Takže teď již mám základ připravený a můžu se dostat k
těm podstatným věcem, a těmi jsou generování událostí a
reakce na ně.</p>
<h1>Události</h1>
<p>Pokud jste někdy přišli do styku s komunikací přes message
broker s využitím vzoru publish-subscribe, pak vám systém
aplikačních událostí ve Spring bude jistě hodně blízký.</p>
<p>V podstatě úlohu message brokeru v tomto případě plní Spring
kontext. 
</p>
<p>Témata se nespecifikují explicitně. Tématem a událostí
zároveň může být instance třídy odvozená od společného
předka <b>ApplicationEvent</b>. 
</p>
<p>V novějších verzích Spring už není stanoven ani tento
požadavek, a událostí může být instance libovolné třídy. Já
ale preferuji odvození událostí od společného předka, protože
na první pohled vidíte, k čemu je definovaná třída určená.</p>
<p>Společný předek všech aplikační událostí <b>ApplicationEvent</b>
je abstraktní třída, která zahrnuje dva atributy:</p>
<ul>
	<li><p><b>source</b> [Object] – objekt, ve kterém vznikla událost
	(při vytvoření instance události se obvykle nastavuje na <i><b>this</b></i>,
	ale nemusí to tak vždy být)</p>
	<li><p><b>timestamp</b> [long] – čas vzniku události uvedený v
	milisekundách</p>
</ul>
<p>Vzhledem k tomu, že ApplicationEvent je abstraktní třída, není
možné použít instanci této třídy jako událost (ona ta
instance nejde ani vytvořit). Musíte si udělat vlastní hierarchii
tříd od ní odvozených, která bude reprezentovat vaše události.</p>
<p>Jednu takovou jsem si vytvořil i já v rámci přípravy tohoto
článku (opět pro přehlednost nejdříve schéma):</p>
<p><img src="image/ApplicationEventsGuide-CustomEvents.jpg" name="Image2" align="left" width="518" height="341">
  <br clear="left"/>
</img>
<br/>
<br/>

</p>
<p>Výchozí třídou pro všechny mé události je <u><b>CustomEvent</b></u>.
Nemá žádné atributy, jen jednu metodu <i>getEvent()</i>, která
vrátí název události jako řetězec poskládaný s názvů tříd
v dědické linii (výsledek uvidíte později).</p>
<p>Dále mám vytvořeny další dvě třídy <b>ProviderEvent</b> a
<b>ApplicantEvent</b>. Ty budou reprezentovat události vzniklé v
poskytovateli služeb, resp. v klientovi. Obě třídy mají
definovány tyto atributy:</p>
<ul>
	<li><p>phase [Phase] – fáze zpracování požadavku (proč tady
	je se pokusím vysvětlit dále)</p>
	<li><p>request [Request] – požadavek na službu</p>
	<li><p>response [Response] – výsledek služby</p>
</ul>
<p>Každá událost sebou může nést, a taky obvykle nese,
doplňující údaje k ní se vztahující. V případě
<i>Provider</i><i>Event</i> jsou to objekty reprezentující
požadavek a výsledek služby. Dle mého názoru je dobré těmito
údaji nešetřit, mohou se vám při reakci na událost hodit.</p>
<p>A teď se ještě vrátím k atributu <i>phase</i>, a co tím
vlastně chci ukázat. 
</p>
<p>Jakým způsobem přistoupit k definici typu událostí, které
mohou vznikat v mé aplikaci?</p>
<ol>
	<li><p>Prvním přístupem který se nabízí, je vytvořit celou
	hierarchickou strukturu tříd odpovídající všem typům
	událostí. Je to dobrý přístup, jen se nám může stát, že
	těch událostí, a k nim definovaných tříd bude velké množství
	(třeba desítky nebo stovky dle rozsahu aplikace a míry sledování
	událostí).</p>
	<li><p>Druhou možností, a asi dost extrémní z druhé strany, je
	vytvoření pouze jedné třídy reprezentující všechny vaše
	události. Ty se pak nebudou rozlišovat podle třídy, ale
	nastavením jednotlivých atributů.</p>
	<li><p>No a poslední možností, kterou právě naznačují
	atributem <i>phase</i>, je kombinace obou výše uvedených
	přístupu. Do jisté úrovně rozlišuji události definicí tříd.
	Detailnější rozlišení je pak pomocí atributu.</p>
</ol>
<p>V diagramu jsou zachyceny ještě dvě třídy reprezentující
aplikační události – <b>SupervisionEvent</b> a
<b>DelayedCustomEvent</b>. K nim se detailněji dostanu v dalších
kapitolách. V tomto okamžiku bude postačovat konstatování, že
tam jsou.</p>
<p>Při definici událostí a hierarchie tříd je potřeba také
brát do úvahy, jak asi budeme chtít na události reagovat. Zda
budeme na některé typy událostí reagovat stejně nebo obdobně.
Ale k tomu blíže až v kapitolách zabývající se reakcí na
události.</p>
<h2 class="western">Oznámení vzniku události</h2>
<p>Oznámení vzniku události je velice triviální a bylo vidět
již v předchozích ukázkách implementace poskytovatele služby
nebo klienta.</p>
<p>Takto nějak to vypadá v implementaci poskytovatele:</p>
<pre class="western"><font color="#080808"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">@Autowired </span></font></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">private </span></font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ApplicationEventPublisher </span></font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">publisher</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">;</span></font></font></font>

<font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Override</font></font></font>
<font color="#080808"><font size="1" style="font-size: 8pt"><font color="#0033b3"><font face="JetBrains Mono, monospace"><span style="font-weight: normal">public </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><span style="font-weight: normal">ResponseA </span></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><span style="font-weight: normal">perform</span></font></font><font face="JetBrains Mono, monospace"><span style="font-weight: normal">(</span></font><font color="#000000"><font face="JetBrains Mono, monospace"><span style="font-weight: normal">RequestA </span></font></font><font face="JetBrains Mono, monospace"><span style="font-weight: normal">request) {</span></font></font></font>

    <font size="1" style="font-size: 8pt">...</font>

<font color="#080808">    <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">publisher</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.publishEvent(</span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">new </span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ProviderEvent(</span></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">this</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, </span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">ProviderEvent</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">Phase</span></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">.</span></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i><span style="font-weight: normal">ASKED</span></i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><span style="font-weight: normal">, request));</span></font></font></font>

    <font size="1" style="font-size: 8pt">...</font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
<br/>
<br/>

</p>
<p>Pro publikování potřebujeme objekt implementující rozhraní
<b>ApplicationEventPublisher</b>. V našem případě je to
jednoduché, neboť takový objekt poskytuje Spring kontext. Stačí
udělat injektáž přes anotaci @Autowire. 
</p>
<p>No a pak na tomto objektu zavolat metodu <i><b>publishEvent()</b></i>
s parametrem instance události. 
</p>
<p>A to je vše.</p>
<p>Na tomto místě, jak nás učí vzor publish-subscribe, neřešíme,
zda na událost někdo reaguje a případně jakým způsobem. To je
úkolem někoho jiného.</p>
<h1>Reakce na událost</h1>
<p>K čemu by nám bylo oznamování vzniku událostí, pokud bychom
na ně nebyli schopni reagovat. V následujících kapitolách se
podívám na možnosti, jak reagovat na vznik událostí a co s daty,
které v rámci události jsou k dipozici. Výčet jistě nebude
konečný. Vždy bude záviset na vaší aplikaci, co a kdy chcete
při jejím běhu sledovat.</p>
<p>Pokud chci zachytit vznik nějaké události, potřebuji splnit
dvě podmínky:</p>
<ol>
	<li><p>Mít nějaký objekt s metodou anotovanou <i><b>@EventListener</b></i>.</p>
	<li><p>Metoda musí mít jeden parametr třídy odvozené od
	<b>ApplicationEvent</b>.</p>
</ol>
<p>Anotací Spring kontextu sděluji, že je metoda určená pro
reakci na aplikační události. Třídou parametru se pak
specifikuje, jaký typ události má být metodou zpracován (to je
jako byste se v případe komunikace <i>publish-subscribe</i>
přihlásili k odebírání zpráv z určitého tématu).</p>
<p>Každý z dále uvedených příkladů reakce na událost je
zahrnut do samostatného profilu. Proto pokud jej chcete vyzkoušet,
musíte při startu zadat tento profil jako aktivní.</p>
<p>Všechny třídy, které implementují metody pro zpracování
událostí, jsou umístěny do package <b>listener</b>. 
</p>
<h2 class="western">Zápis události to logu</h2>
<table width="100%" cellpadding="4" cellspacing="0" style="background: transparent; page-break-inside: auto">
	<col width="39*"/>

	<col width="217*"/>

	<tr style="background: transparent" valign="top">
		<td width="15%" bgcolor="#dddddd" style="background: #dddddd; border-top: 1px solid #000000; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0.02in; padding-bottom: 0.02in; padding-left: 0.02in; padding-right: 0in"><p align="right">
			<font size="2" style="font-size: 10pt"><b>Třída: </b></font>
			</p>
		</td>
		<td width="85%" style="background: transparent; border: 1px solid #000000; padding: 0.04in"><p align="left">
			<code class="western"><span style="font-variant: normal"><font color="#000000"><span style="text-decoration: none"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span style="font-style: normal"><b>SimpleEventListener</b></span></font></font></span></font></span></code></p>
		</td>
	</tr>
	<tr style="background: transparent" valign="top">
		<td width="15%" bgcolor="#dddddd" style="background: #dddddd; border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0in; padding-bottom: 0.02in; padding-left: 0.02in; padding-right: 0in"><p align="right">
			<font size="2" style="font-size: 10pt"><b>Profil: </b></font>
			</p>
		</td>
		<td width="85%" style="background: transparent; border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0.04in"><p align="left">
			<code class="western"><span style="font-variant: normal"><font color="#000000"><span style="text-decoration: none"><font face="Liberation Serif, serif"><font size="3" style="font-size: 12pt"><span style="font-style: normal"><b>listener-simple</b></span></font></font></span></font></span></code></p>
		</td>
	</tr>
</table>
<p>Asi to nejjednodušší, co bychom mohli s události udělat, je
zápis do logu. Zde je tedy takový příklad pro zápis o vzniku
události ProviderEvent a ApplicantEvent:</p>
<pre class="western"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Service</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#9e880d">@Profile</font>(<font color="#067d17">&quot;listener-simple&quot;</font>)</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">SimpleEventListener </font>{</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private static final </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Logger </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger </i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">LoggerFactory</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>getLogger</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">SimpleEventListener</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">class</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@EventListener</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Order</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#1750eb"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">10</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">handleApplicantEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicantEvent </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event) {</font></font></font>
<font color="#080808">        <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.info(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Applicant Event handled: {} by {} at {}&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">,</font></font></font>
<font color="#080808">                <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">StringUtils</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>rightPad</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(event.getPhase().toString(), </font></font><font color="#1750eb"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">10</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">),</font></font></font>
<font color="#080808">                <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event.getSource().getClass().getSimpleName(),</font></font></font>
<font color="#080808">                <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">SimpleDateFormat(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;HH:mm:ss&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">).format(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Date(event.getTimestamp())));</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@EventListener</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Order</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#1750eb"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">10</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">handleProviderEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ProviderEvent </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event) {</font></font></font>
<font color="#080808">        <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.info(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Provider Event handled:  {} by {} at {}&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">,</font></font></font>
<font color="#080808">                <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">StringUtils</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>rightPad</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(event.getPhase().toString(), </font></font><font color="#1750eb"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">10</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">),</font></font></font>
<font color="#080808">                <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event.getSource().getClass().getSimpleName(),</font></font></font>
<font color="#080808">                <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">SimpleDateFormat(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;HH:mm:ss&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">).format(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Date(event.getTimestamp())));</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Třída je anotovaná jako <i>@Service</i>, takže při startu budu
mít ve Spring kontextu jednu její instanci. 
</p>
<p>Dále mám definovány dvě metody, jedna pro obsluhu události
typu ApplicantEvent a druhá pro ProviderEvent. Do logu pak mohu
zapsat i údaje, které si vytáhnu z instance události (to je ta
instance, kterou jsem předal při volání <b>publishEvent()</b>. 
</p>
<h3 class="western">Jak si to mohu zkusit</h3>
<p>Nejdříve si pustím server s profilem:</p>
<pre class="western" style="margin-bottom: 0.2in">[raska@fedora jv-application-events-guide]$ java -jar target/application-events-guide-1.0.0.jar --spring.profiles.active=listener-simple</pre><p>
Dále pak z jiného příkazového řádku vyvolám službu:</p>
<pre class="western">[raska@fedora ~]$ jo -p nid=local:node02 name=node02 tid=${RANDOM} value=20 | curl -s -X GET --data-binary @- -H &quot;Content-type: application/json&quot; http://localhost:8080/rest/serviceA | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;nid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;local:node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;name&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;8062&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ts&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2021-12-12T09:19:14.885+00:00&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;code&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;OK&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;result&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">21</font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><p>
Terminál se spuštěným serverem by měl vypisovat něco takového:</p>
<pre class="western"><font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-12 10:19:14.885 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3233</font> --- [nio-8080-exec-1] <font color="#2aa1b3">c.d.a.listener.SimpleEventListener      </font> : Provider Event handled:  ASKED      by ServiceProviderA at 10:19:14</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-12 10:19:14.885 </font><font color="#26a269"> INFO</font> <font color="#a347ba">3233</font> --- [nio-8080-exec-1] <font color="#2aa1b3">c.d.a.listener.SimpleEventListener      </font> : Provider Event handled:  ANSWERED   by ServiceProviderA at 10:19:14</font></pre><h2 class="western">
Výpis události jako JSON objekt</h2>
<table width="100%" cellpadding="4" cellspacing="0" style="background: transparent; page-break-inside: auto">
	<col width="39*"/>

	<col width="217*"/>

	<tr style="background: transparent" valign="top">
		<td width="15%" bgcolor="#dddddd" style="background: #dddddd; border-top: 1px solid #000000; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0.02in; padding-bottom: 0.02in; padding-left: 0.02in; padding-right: 0in"><p align="right">
			<font size="2" style="font-size: 10pt"><b>Třída: </b></font>
			</p>
		</td>
		<td width="85%" style="background: transparent; border: 1px solid #000000; padding: 0.04in"><p align="left">
			<b>JsonEventListener</b></p>
		</td>
	</tr>
	<tr style="background: transparent" valign="top">
		<td width="15%" bgcolor="#dddddd" style="background: #dddddd; border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0in; padding-bottom: 0.02in; padding-left: 0.02in; padding-right: 0in"><p align="right">
			<font size="2" style="font-size: 10pt"><b>Profil: </b></font>
			</p>
		</td>
		<td width="85%" style="background: transparent; border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0.04in"><p align="left">
			<b>listener-json</b></p>
		</td>
	</tr>
</table>
<p>V případě, že by vás zajímaly všechny informace, které si
sebou nese daná událost, můžete si je vypsat do logu například
jako JSON objekt. A to dělá právě tato třída:</p>
<pre class="western"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Service</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#9e880d">@Profile</font>(<font color="#067d17">&quot;listener-json&quot;</font>)</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">JsonEventListener </font>{</font></font></font>

<font color="#080808">    <font size="1" style="font-size: 8pt"><font color="#0033b3"><font face="JetBrains Mono, monospace">private static final </font></font><font color="#000000"><font face="JetBrains Mono, monospace">Logger </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><i>logger </i></font></font><font face="JetBrains Mono, monospace">= </font><font color="#000000"><font face="JetBrains Mono, monospace">LoggerFactory</font></font><font face="JetBrains Mono, monospace">.</font><font face="JetBrains Mono, monospace"><i>getLogger</i></font><font face="JetBrains Mono, monospace">(</font><font color="#000000"><font face="JetBrains Mono, monospace">JsonEventListener</font></font><font face="JetBrains Mono, monospace">.</font><font color="#0033b3"><font face="JetBrains Mono, monospace">class</font></font><font face="JetBrains Mono, monospace">);</font></font></font>

<font color="#080808">    <font size="1" style="font-size: 8pt"><font color="#9e880d"><font face="JetBrains Mono, monospace">@Autowired </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace">private </font></font><font color="#000000"><font face="JetBrains Mono, monospace">ObjectMapper </font></font><font color="#871094"><font face="JetBrains Mono, monospace">objectMapper</font></font><font face="JetBrains Mono, monospace">;</font></font></font>

<font color="#080808">    <font size="1" style="font-size: 8pt"><font color="#9e880d"><font face="JetBrains Mono, monospace">@EventListener</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font size="1" style="font-size: 8pt"><font color="#9e880d"><font face="JetBrains Mono, monospace">@Order</font></font><font face="JetBrains Mono, monospace">(</font><font color="#1750eb"><font face="JetBrains Mono, monospace">20</font></font><font face="JetBrains Mono, monospace">)</font></font></font>
<font color="#080808">    <font size="1" style="font-size: 8pt"><font color="#0033b3"><font face="JetBrains Mono, monospace">public void </font></font><font color="#00627a"><font face="JetBrains Mono, monospace">handleEvent</font></font><font face="JetBrains Mono, monospace">(</font><font color="#000000"><font face="JetBrains Mono, monospace">CustomEvent </font></font><font face="JetBrains Mono, monospace">event) {</font></font></font>
<font color="#080808">        <font size="1" style="font-size: 8pt"><font color="#0033b3"><font face="JetBrains Mono, monospace">try </font></font><font face="JetBrains Mono, monospace">{</font></font></font>
<font color="#080808">            <font size="1" style="font-size: 8pt"><font color="#871094"><font face="JetBrains Mono, monospace"><i>logger</i></font></font><font face="JetBrains Mono, monospace">.info(</font><font color="#067d17"><font face="JetBrains Mono, monospace">&quot;Custom Event {} handled: JSON DATA: </font></font><font color="#0037a6"><font face="JetBrains Mono, monospace">\n</font></font><font color="#067d17"><font face="JetBrains Mono, monospace">{}&quot;</font></font><font face="JetBrains Mono, monospace">, event.getClass().getSimpleName(), </font><font color="#871094"><font face="JetBrains Mono, monospace">objectMapper</font></font><font face="JetBrains Mono, monospace">.writerWithDefaultPrettyPrinter().writeValueAsString(event));</font></font></font>
<font color="#080808">        <font size="1" style="font-size: 8pt"><font face="JetBrains Mono, monospace">} </font><font color="#0033b3"><font face="JetBrains Mono, monospace">catch </font></font><font face="JetBrains Mono, monospace">(</font><font color="#000000"><font face="JetBrains Mono, monospace">JsonProcessingException </font></font><font face="JetBrains Mono, monospace">e) {</font></font></font>
<font color="#080808">            <font size="1" style="font-size: 8pt"><font color="#871094"><font face="JetBrains Mono, monospace"><i>logger</i></font></font><font face="JetBrains Mono, monospace">.error(</font><font color="#067d17"><font face="JetBrains Mono, monospace">&quot;Object to JSON mapping failed!&quot;</font></font><font face="JetBrains Mono, monospace">, e);</font></font></font>
<font color="#080808">        <font size="1" style="font-size: 8pt"><font face="JetBrains Mono, monospace">}</font></font></font>
<font color="#080808">    <font size="1" style="font-size: 8pt"><font face="JetBrains Mono, monospace">}</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Chtěl bych upozornit na jednu věc, a sice typ parametru event. V
tomto případě je event definován jako abstraktní předek
<b>CustomEvent</b>. To znamená, že bude přijímat všechny
události, které jsou od něj odvozeny.</p>
<p>A ještě jedna poznámka, která se týká anotace <i><b>@Order</b></i>.
Metod, které mohou přijmout a zpracovat konkrétní událost, může
být několik. Obecně není specifikováno, v jakém pořadí se
budou provádět. V případě, že vám záleží na tom, v jakém
pořadí se boudou metody volat, můžete použít právě tuto
anotaci. Parametrem je pořadí ... čím menší číslo, tím výše
v pořadí metoda bude. 
</p>
<h3 class="western">Jak si to mohu zkusit</h3>
<p>Opět si spustím server a přidělím mu dva profily,
listener-simple a listener-json:</p>
<pre class="western" style="margin-bottom: 0.2in">[raska@fedora jv-application-events-guide]$ java -jar target/application-events-guide-1.0.0.jar --spring.profiles.active=listener-simple,listener-json</pre><p>
Dále pak z jiného příkazového řádku vyvolám službu:</p>
<pre class="western">[raska@fedora ~]$ jo -p nid=local:node03 name=node03 tid=$RANDOM text=blablabla | curl -s -X GET --data-binary @- -H &quot;Content-type: application/json&quot; http://localhost:8080/rest/serviceB | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;nid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;local:node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;name&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;28188&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ts&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2021-12-12T08:59:50.836+00:00&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;code&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;OK&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;text&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;text length: 9&quot;</font></font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><p>
Terminál se spuštěným serverem by měl vypisovat něco takového:</p>
<pre class="western"><font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-12 09:59:50.755 </font><font color="#26a269"> INFO</font> <font color="#a347ba">5276</font> --- [nio-8080-exec-1] <font color="#2aa1b3">c.d.a.listener.SimpleEventListener      </font> : Provider Event handled:  ASKED      by ServiceProviderB at 09:59:50</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-12 09:59:50.835 </font><font color="#26a269"> INFO</font> <font color="#a347ba">5276</font> --- [nio-8080-exec-1] <font color="#2aa1b3">c.d.a.listener.JsonEventListener        </font> : Custom Event ProviderEvent handled: JSON DATA: </font>
<font size="1" style="font-size: 8pt">{</font>
  <font size="1" style="font-size: 8pt">&quot;source&quot; : {</font>
    <font size="1" style="font-size: 8pt">&quot;instanceName&quot; : &quot;Provider B&quot;</font>
  <font size="1" style="font-size: 8pt">},</font>
  <font size="1" style="font-size: 8pt">&quot;timestamp&quot; : 1639299590748,</font>
  <font size="1" style="font-size: 8pt">&quot;phase&quot; : &quot;ASKED&quot;,</font>
  <font size="1" style="font-size: 8pt">&quot;request&quot; : {</font>
    <font size="1" style="font-size: 8pt">&quot;nid&quot; : &quot;local:node03&quot;,</font>
    <font size="1" style="font-size: 8pt">&quot;name&quot; : &quot;node03&quot;,</font>
    <font size="1" style="font-size: 8pt">&quot;tid&quot; : &quot;28188&quot;,</font>
    <font size="1" style="font-size: 8pt">&quot;ts&quot; : &quot;2021-12-12T08:59:50.740+00:00&quot;,</font>
    <font size="1" style="font-size: 8pt">&quot;text&quot; : &quot;blablabla&quot;</font>
  <font size="1" style="font-size: 8pt">},</font>
  <font size="1" style="font-size: 8pt">&quot;response&quot; : null,</font>
  <font size="1" style="font-size: 8pt">&quot;event&quot; : &quot;CustomEvent.ProviderEvent.ASKED&quot;</font>
<font size="1" style="font-size: 8pt">}</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-12 09:59:50.838 </font><font color="#26a269"> INFO</font> <font color="#a347ba">5276</font> --- [nio-8080-exec-1] <font color="#2aa1b3">c.d.a.listener.SimpleEventListener      </font> : Provider Event handled:  ANSWERED   by ServiceProviderB at 09:59:50</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-12 09:59:50.840 </font><font color="#26a269"> INFO</font> <font color="#a347ba">5276</font> --- [nio-8080-exec-1] <font color="#2aa1b3">c.d.a.listener.JsonEventListener        </font> : Custom Event ProviderEvent handled: JSON DATA: </font>
<font size="1" style="font-size: 8pt">{</font>
  <font size="1" style="font-size: 8pt">&quot;source&quot; : {</font>
    <font size="1" style="font-size: 8pt">&quot;instanceName&quot; : &quot;Provider B&quot;</font>
  <font size="1" style="font-size: 8pt">},</font>
  <font size="1" style="font-size: 8pt">&quot;timestamp&quot; : 1639299590838,</font>
  <font size="1" style="font-size: 8pt">&quot;phase&quot; : &quot;ANSWERED&quot;,</font>
  <font size="1" style="font-size: 8pt">&quot;request&quot; : {</font>
    <font size="1" style="font-size: 8pt">&quot;nid&quot; : &quot;local:node03&quot;,</font>
    <font size="1" style="font-size: 8pt">&quot;name&quot; : &quot;node03&quot;,</font>
    <font size="1" style="font-size: 8pt">&quot;tid&quot; : &quot;28188&quot;,</font>
    <font size="1" style="font-size: 8pt">&quot;ts&quot; : &quot;2021-12-12T08:59:50.740+00:00&quot;,</font>
    <font size="1" style="font-size: 8pt">&quot;text&quot; : &quot;blablabla&quot;</font>
  <font size="1" style="font-size: 8pt">},</font>
  <font size="1" style="font-size: 8pt">&quot;response&quot; : {</font>
    <font size="1" style="font-size: 8pt">&quot;nid&quot; : &quot;local:node01&quot;,</font>
    <font size="1" style="font-size: 8pt">&quot;name&quot; : &quot;node01&quot;,</font>
    <font size="1" style="font-size: 8pt">&quot;tid&quot; : &quot;28188&quot;,</font>
    <font size="1" style="font-size: 8pt">&quot;ts&quot; : &quot;2021-12-12T08:59:50.836+00:00&quot;,</font>
    <font size="1" style="font-size: 8pt">&quot;code&quot; : &quot;OK&quot;,</font>
    <font size="1" style="font-size: 8pt">&quot;text&quot; : &quot;text length: 9&quot;</font>
  <font size="1" style="font-size: 8pt">},</font>
  <font size="1" style="font-size: 8pt">&quot;event&quot; : &quot;CustomEvent.ProviderEvent.ANSWERED&quot;</font>
<font size="1" style="font-size: 8pt">}</font></pre><p>
Vidíte, že nejdříve mám záznamy ze třídy SimpleEventListener
následované záznamy z JsonEventListener.</p>
<p>Dále bych chtěl ještě upozornit na atribut event, který je
vytvořen na základě názvů tříd hierarchie událostí v
kombinaci a dalšími atributy.</p>
<h2 class="western">Dlouhé zpracování události</h2>
<table width="100%" cellpadding="4" cellspacing="0" style="background: transparent; page-break-inside: auto">
	<col width="39*"/>

	<col width="217*"/>

	<tr style="background: transparent" valign="top">
		<td width="15%" bgcolor="#dddddd" style="background: #dddddd; border-top: 1px solid #000000; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0.02in; padding-bottom: 0.02in; padding-left: 0.02in; padding-right: 0in"><p align="right">
			<font size="2" style="font-size: 10pt"><b>Třída: </b></font>
			</p>
		</td>
		<td width="85%" style="background: transparent; border: 1px solid #000000; padding: 0.04in"><p align="left">
			<b>LongLastingEventListener</b></p>
		</td>
	</tr>
	<tr style="background: transparent" valign="top">
		<td width="15%" bgcolor="#dddddd" style="background: #dddddd; border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0in; padding-bottom: 0.02in; padding-left: 0.02in; padding-right: 0in"><p align="right">
			<font size="2" style="font-size: 10pt"><b>Profil: </b></font>
			</p>
		</td>
		<td width="85%" style="background: transparent; border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0.04in"><p align="left">
			<b>listener-long</b></p>
		</td>
	</tr>
</table>
<p>Nejdříve si zkuste tohle a pak až vysvětlím, co se to vlastně
děje.</p>
<p>Takže nejdříve spustit server s profilem listener-long:</p>
<pre class="western" style="margin-bottom: 0.2in">[raska@fedora jv-application-events-guide]$ java -jar target/application-events-guide-1.0.0.jar --spring.profiles.active=listener-long</pre><p>
A dále pak zavolat službu:</p>
<pre class="western">[raska@fedora ~]$ time jo -p nid=local:node03 name=node03 tid=$RANDOM text=blablabla | curl -s -X GET --data-binary @- -H &quot;Content-type: application/json&quot; http://localhost:8080/rest/serviceB | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;nid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;local:node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;name&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;16211&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ts&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2021-12-12T09:17:19.990+00:00&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;code&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;OK&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;text&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;text length: 9&quot;</font></font>
<font size="1" style="font-size: 8pt"><b>}</b></font>

real    0m10.502s
user    0m0.042s
sys     0m0.015s</pre><p>
Odpověď jsem dostal v pořádku, ale proč to trvalo tak dlouho?</p>
<p>Když se podíváte na implementaci metody, bude to asi zřejmé:</p>
<pre class="western"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Service</font></font></font>
<font color="#8c8c8c"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>//@EnableAsync</i></font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#9e880d">@Profile</font>(<font color="#067d17">&quot;listener-long&quot;</font>)</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">LongLastingEventListener </font>{</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private static final </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Logger </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger </i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">LoggerFactory</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>getLogger</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">LongLastingEventListener</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">class</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>

<font color="#8c8c8c"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>//    @Async</i></font></font></font>
<font color="#080808"><font color="#8c8c8c">    </font><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@EventListener</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Order</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#1750eb"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">30</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">handleEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ProviderEvent </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event) {</font></font></font>
<font color="#080808">        <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.info(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Provider Event started ...&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">try </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">{</font></font></font>
<font color="#080808">            <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Thread</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>sleep</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#1750eb"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">5000</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">        <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">} </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">catch </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">InterruptedException </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">e) {</font></font></font>
<font color="#080808">            <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.error(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Exception occurred&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, e);</font></font></font>
<font color="#080808">        <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">        <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.info(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Provider Event finished ...&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Metoda nedělá nic podstatného, pouze zastaví provádění na 5
sekund.</p>
<p><u><b>To, že se nám to pozastavení promítlo do celkové doby
zpracování služby znamená, že reakce na události se běžně
zpracovávají ve stejném vláknu jako kód, který událost
vytvořil </b></u><span style="text-decoration: none"><span style="font-weight: normal">(zpracování
událostí je synchronní s vytvářením).</span></span></p>
<p>To ale obvykle nechceme. Nechceme, aby sledování běhu našeho
systému přímo ovlivňovalo efektivitu poskytování jeho služeb.</p>
<p>Z toho plyne následující:</p>
<p><u>Pokud připravujete reakce na události, které mohou
konzumovat nezanedbatelný čas, je vždy dobré je udělat jako
asynchronní. </u>
</p>
<p>A proto jsou v implementaci zakomentovány dvě anotace, a sice
<i>@EnableAsync</i> u třídy a <i>@Async</i> u metody.</p>
<p>Zkuste je odkomentovat, sestavit projekt a spustit znovu. Pak by
váš výsledek měl vypadat daleko lépe:</p>
<pre class="western">[raska@fedora ~]$ time jo -p nid=local:node03 name=node03 tid=$RANDOM text=blablabla | curl -s -X GET --data-binary @- -H &quot;Content-type: application/json&quot; http://localhost:8080/rest/serviceB | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;nid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;local:node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;name&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;12410&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ts&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2021-12-12T09:29:51.737+00:00&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;code&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;OK&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;text&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;text length: 9&quot;</font></font>
<font size="1" style="font-size: 8pt"><b>}</b></font>

real    0m0.562s
user    0m0.038s
sys     0m0.019s</pre><p>
Jen ještě upozorním na výpisy, které se dělají při reakci na
událost:</p>
<pre class="western"><font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-12 10:29:51.753 </font><font color="#26a269"> INFO</font> <font color="#a347ba">6195</font> --- [         task-1] <font color="#2aa1b3">c.d.a.listener.LongLastingEventListener </font> : Provider Event started ...</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-12 10:29:51.765 </font><font color="#26a269"> INFO</font> <font color="#a347ba">6195</font> --- [         task-2] <font color="#2aa1b3">c.d.a.listener.LongLastingEventListener </font> : Provider Event started ...</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-12 10:29:56.754 </font><font color="#26a269"> INFO</font> <font color="#a347ba">6195</font> --- [         task-1] <font color="#2aa1b3">c.d.a.listener.LongLastingEventListener </font> : Provider Event finished ...</font>
<font size="1" style="font-size: 8pt"><font color="#aaaaaa">2021-12-12 10:29:56.766 </font><font color="#26a269"> INFO</font> <font color="#a347ba">6195</font> --- [         task-2] <font color="#2aa1b3">c.d.a.listener.LongLastingEventListener </font> : Provider Event finished ...</font></pre><p>
Z časů je vidět, že doba zpracování je stále těch 5 sekund.</p>
<h2 class="western">Auditní záznam do SQL databáze</h2>
<table width="100%" cellpadding="4" cellspacing="0" style="background: transparent; page-break-inside: auto">
	<col width="39*"/>

	<col width="217*"/>

	<tr style="background: transparent" valign="top">
		<td width="15%" bgcolor="#dddddd" style="background: #dddddd; border-top: 1px solid #000000; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0.02in; padding-bottom: 0.02in; padding-left: 0.02in; padding-right: 0in"><p align="right">
			<font size="2" style="font-size: 10pt"><b>Třída: </b></font>
			</p>
		</td>
		<td width="85%" style="background: transparent; border: 1px solid #000000; padding: 0.04in"><p align="left">
			<b>JPAEventListener</b></p>
		</td>
	</tr>
	<tr style="background: transparent" valign="top">
		<td width="15%" bgcolor="#dddddd" style="background: #dddddd; border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0in; padding-bottom: 0.02in; padding-left: 0.02in; padding-right: 0in"><p align="right">
			<font size="2" style="font-size: 10pt"><b>Profil: </b></font>
			</p>
		</td>
		<td width="85%" style="background: transparent; border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0.04in"><p align="left">
			<b>listener-jpa</b></p>
		</td>
	</tr>
</table>
<p>V této kapitole se podívám na řešení, na které jsem se
odkazoval již v úvodu této série článků, a sice na auditní
záznamy o běhu aplikace.</p>
<p>V podstatě se jedná o perzistentní uložení vybraných údajů
o událostech vzniklých za běhu aplikace.</p>
<p>Takže co k tomu budu potřebovat?</p>
<ol>
	<li><p>Vydefinovat si události a údaje, které o nich budu sbírat</p>
	<li><p>Připravit si perzistentní úložiště, což bude v tomto
	případě nějaký typ SQL databáze</p>
	<li><p>Implementovat reakci na vybrané události</p>
</ol>
<p>Vzhledem k tomu, že po perzistentním úložišti nebudu
požadovat žádné zvláštní služby, použil jsem pro přístup k
SQL databázi podporu JPA integrovanou rovnou do framework.</p>
<h3 class="western">Auditní záznamy</h3>
<p>Pro ukázku mně bude postačovat, pokud budu reagovat na událost
poskytovatele služeb o úspěšně provedené službě.</p>
<p>Nejdříve potřebuji navrhnout datové struktury, které mně
budou reprezentovat události. Jejich implementace je v package
<b>entity/audit</b>.</p>
<p>Opět mám připraveného jednoho společného předka pro všechny
typy auditních záznamů, <b>AuditRecord</b>:</p>
<pre class="western"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Entity</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">AuditRecord </font>{</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Id</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@GeneratedValue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(strategy = </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">GenerationType</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>AUTO</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Long </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">id</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Column</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(nullable = </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">false</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">UUID </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">oid</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Column</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(nullable = </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">false</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Column</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">URI </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">tid</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Column</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(nullable = </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">false</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Date </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ts</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#0033b3">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">AuditRecord</font></font></font><font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() {  }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">AuditRecord</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">URI </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">tid) {</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">oid </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">UUID</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>randomUUID</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">();</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= event;</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">tid </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= tid;</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ts </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Date();</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Long </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getId</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() { </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">id</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">setId</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Long </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">id) { </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">id </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= id; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">UUID </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getOid</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() { </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">oid</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">setOid</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">UUID </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">oid) {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">oid </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= oid;</font></font> <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font> <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">setEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event) {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= event; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">URI </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getTid</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">tid</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">setTid</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">URI </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">tid) {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">tid </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= tid; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Date </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getTs</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() { </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ts</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">setTs</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Date </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ts) {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ts </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= ts; }</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Jsou zde definovány všechny údaje, které bodu sledovat pro každý
auditní záznam.</p>
<p>No a pak zde mám ještě jednu specifickou třídu pouze pro typ
události poskytovatele, <b>ProviderAuditRecord</b>:</p>
<pre class="western"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Entity</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">ProviderAuditRecord </font><font color="#0033b3">extends </font><font color="#000000">AuditRecord </font>{</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Column</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">requestFrom</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Column</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">providerName</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Column</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ResponseCodeType </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">code</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ProviderAuditRecord</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() { </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">super</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(); }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ProviderAuditRecord</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">URI </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">tid) {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">super</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(event, tid);</font></font> <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getRequestFrom</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">requestFrom</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font> <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">setRequestFrom</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">requestFrom) {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">requestFrom </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= requestFrom;</font></font> <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getProviderName</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">providerName</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font> <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">setProviderName</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">providerName) {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">providerName </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= providerName;</font></font> <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ResponseCodeType </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getCode</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">code</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">setCode</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ResponseCodeType </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">code) {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">code </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= code;</font></font> <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Poslední třídu, kterou můžete v package najít, je
<b>URIPersistenceConverter</b>. Ta slouží ke konverzi třídy URI
na řetězec znaků pro uložení v databázi. 
</p>
<pre class="western"><font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#9e880d">@Converter</font>(autoApply = <font color="#0033b3">true</font>)</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">URIPersistenceConverter </font><font color="#0033b3">implements </font><font color="#000000">AttributeConverter</font>&lt;<font color="#000000">URI</font>, <font color="#000000">String</font>&gt; {</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Override</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">convertToDatabaseColumn</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">URI </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">uri) {</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(uri != </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">null</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">) ? uri.toString() : </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">null</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Override</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">URI </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">convertToEntityAttribute</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">s) {</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">StringUtils</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>isNoneBlank</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(s)) ? </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">URI</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>create</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(s.trim()) : </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">null</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><h3 class="western">
Úložiště pro auditní záznamy</h3>
<p>Jako SQL úložiště jsem pro účely ukázky použil databázi
H2. Jistě to nebude preferované řešení pro rutinní použití,
ale zde to bude postačovat.</p>
<p>Databáze má spuštěnou podporu pro webovou konzolu na URL
<a href="http://localhost:8080/h2-console">http://localhost:8080/h2-console</a>.</p>
<p>Pro připojení budete potřebovat URN, které se vám zobrazí
při startu serveru. Vypadá nějak takto
<i>jdbc:h2:mem:fa36e33a-9ed0-4928-beac-55c54c6f75b4</i>, ale při
každém startu aplikace se mění.</p>
<p>Třídy, jejichž instance budu chtít ukládat do databáze, jsou
anotovány dle požadavků JPA. V této ukázce nechci suplovat
daleko lepší návody na JPA, takže zde jsem použil jen to
nejnutnější pro prezentaci.</p>
<p>Pro přístup k databázi budu potřebovat instanci třídy
odvozené od <b>CrudRepository</b>. 
</p>
<p>Takovou třídu najdete v <b>component/ProviderAuditRepository</b>:</p>
<pre class="western"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Service</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#9e880d">@Profile</font>(<font color="#067d17">&quot;listener-jpa&quot;</font>)</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public interface </font><font color="#000000">ProviderAuditRepository </font><font color="#0033b3">extends </font><font color="#000000">CrudRepository</font>&lt;<font color="#000000">ProviderAuditRecord</font>, <font color="#000000">Long</font>&gt; { }</font></font></font></pre><p>
Vzhledem k tomu, že si vystačím se základními CRUD operacemi,
může být tělo třídy prázdné. 
</p>
<h3 class="western">Implementace reakce na událost</h3>
<p>A nyní se již dostávám k metodě reagující na událost
zápisem auditního záznamu do databáze.</p>
<pre class="western"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Service</font></font></font>
<font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@EnableAsync</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#9e880d">@Profile</font>(<font color="#067d17">&quot;listener-jpa&quot;</font>)</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">JPAEventListener </font>{</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private static final </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Logger </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger </i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">LoggerFactory</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>getLogger</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">JPAEventListener</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">class</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Autowired </font></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ProviderAuditRepository </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">repo</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Async</font></font></font></font>
<font color="#9e880d">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@EventListener</font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">handleEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ProviderEvent </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event) {</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">if </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(event.getPhase() == </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ProviderEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Phase</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>ANSWERED</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">) {</font></font></font>
<font color="#080808">            <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ProviderAuditRecord record </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ProviderAuditRecord(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;service.provider.answer&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, event.getRequest().getTid());</font></font></font>
<font color="#080808">            <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">record</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.setRequestFrom(event.getRequest().getName());</font></font></font>
<font color="#080808">            <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">record</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.setProviderName(((</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ServiceProvider</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;? </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">extends </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Request</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, ? </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">extends </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&gt;)event.getSource()).getInstanceName());</font></font></font>
<font color="#080808">            <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">if </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(event.getResponse() != </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">null</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">                <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">record</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.setCode(event.getResponse().getCode());</font></font></font>
<font color="#080808">            <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">repo</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.save(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">record</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">            <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.info(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;ProviderAuditRecord was written to the database ...&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">        <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
První věc, na kterou bych rád upozornil, je asynchronní
zpracování události.</p>
<p>Metoda zpracovává pouze událost typu <b>ProviderEvent</b>, a
navíc pouze ve fázi <b>ANSWERED</b> (tedy událost po dokončení
zpracování služby). 
</p>
<p>Vytvořím instanci <b>ProviderAuditRecord</b>, naplním jí daty
a uložím prostřednictvím JPA repository (instance ze Spring
kontextu).</p>
<h3 class="western">Přístup k auditním záznamům</h3>
<p>Obsah databáze můžete zkontrolovat prostřednictvím webové
konzoly, jak jsem popsal v předchozí kapitole. 
</p>
<p>Nebo jsem udělal ještě jednu možnost, a to webovou službu
<b>rest/AuditController</b>, která mně vrátí obsah repository.</p>
<pre class="western"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@RestController</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#9e880d">@Profile</font>(<font color="#067d17">&quot;listener-jpa&quot;</font>)</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">AuditController </font>{</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Autowired </font></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ProviderAuditRepository </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">repo</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@RequestMapping</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(value = </font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;/audit&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, method = {</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">RequestMethod</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>GET</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">RequestMethod</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>POST</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">})</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">List</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">AuditRecord</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&gt; </font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">findAll</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() {</font></font></font>
<font color="#080808">        <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">List</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">AuditRecord</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&gt; </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ArrayList&lt;&gt;();</font></font></font>
<font color="#080808">        <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">repo</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.findAll().forEach(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">::add);</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Výsledkem je JSON pole se všemi auditními záznamy, a to vše na
adrese <b>/audit</b>.</p>
<h3 class="western">Jak si to mohu zkusit</h3>
<p>Začneme opět tím, že spustíme server, nyní s profilem
<b>listener-jpa</b>. 
</p>
<pre class="western" style="margin-bottom: 0.2in">[raska@fedora jv-application-events-guide]$ java -jar target/application-events-guide-1.0.0.jar --spring.profiles.active=listener-jpa</pre><p>
A z jiného terminálu si vyvolám postupně obě služby:</p>
<pre class="western">[raska@fedora ~]$ jo -p nid=local:node02 name=node02 tid=${RANDOM} value=20 | curl -s -X GET --data-binary @- -H &quot;Content-type: application/json&quot; http://localhost:8080/rest/serviceA | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;nid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;local:node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;name&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;22904&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ts&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2021-12-12T17:14:24.760+00:00&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;code&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;OK&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;result&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">28</font>
<font size="1" style="font-size: 8pt"><b>}</b></font>
[raska@fedora ~]$ jo -p nid=local:node03 name=node03 tid=$RANDOM text=blablabla | curl -s -X GET --data-binary @- -H &quot;Content-type: application/json&quot; http://localhost:8080/rest/serviceB | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;nid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;local:node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;name&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;28395&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ts&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2021-12-12T17:14:31.261+00:00&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;code&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;OK&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;text&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;text length: 9&quot;</font></font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><p>
A nyní se můžu přesvědčit, co se mně objevilo v databázi:</p>
<pre class="western">[raska@fedora ~]$ curl -s http://localhost:8080/audit | jq .
<font size="1" style="font-size: 8pt"><b>[</b></font>
  <font size="1" style="font-size: 8pt"><b>{</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1</font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;oid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;6f25acca-501f-4fd9-8188-ac6f8706eae8&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;event&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;service.provider.answer&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;22904&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ts&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2021-12-12T17:14:24.776+00:00&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;requestFrom&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;node02&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;providerName&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;Provider A&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;code&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;OK&quot;</font></font>
  <font size="1" style="font-size: 8pt"><b>},</b></font>
  <font size="1" style="font-size: 8pt"><b>{</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">2</font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;oid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;45266ed7-5a5d-493d-9a23-58ba3bd260e2&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;event&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;service.provider.answer&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;28395&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ts&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2021-12-12T17:14:31.277+00:00&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;requestFrom&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;node03&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;providerName&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;Provider B&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;code&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;OK&quot;</font></font>
  <font size="1" style="font-size: 8pt"><b>}</b></font>
<font size="1" style="font-size: 8pt"><b>]</b></font></pre><h2 class="western">
Perzistentní uložení do NoSQL databáze</h2>
<table width="100%" cellpadding="4" cellspacing="0" style="background: transparent; page-break-inside: auto">
	<col width="39*"/>

	<col width="217*"/>

	<tr style="background: transparent" valign="top">
		<td width="15%" bgcolor="#dddddd" style="background: #dddddd; border-top: 1px solid #000000; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0.02in; padding-bottom: 0.02in; padding-left: 0.02in; padding-right: 0in"><p align="right">
			<font size="2" style="font-size: 10pt"><b>Třída: </b></font>
			</p>
		</td>
		<td width="85%" style="background: transparent; border: 1px solid #000000; padding: 0.04in"><p align="left">
			<b>CouchDBEventListener</b></p>
		</td>
	</tr>
	<tr style="background: transparent" valign="top">
		<td width="15%" bgcolor="#dddddd" style="background: #dddddd; border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0in; padding-bottom: 0.02in; padding-left: 0.02in; padding-right: 0in"><p align="right">
			<font size="2" style="font-size: 10pt"><b>Profil: </b></font>
			</p>
		</td>
		<td width="85%" style="background: transparent; border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0.04in"><p align="left">
			<b>listener-couchdb</b></p>
		</td>
	</tr>
</table>
<p>Zápis auditních záznamů do SQL databáze, jak jsem jej
ukazoval v předchozí kapitole, má jednu významnou nepříjemnost.
Musíte si dopředu navrhnout, jaké údaje chcete ke každé
události zaznamenat. K nim pak vytvořit entity a jejich mapování
do databáze. Pokud se v průběhu času rozhodnete sledovat nějaké
další události či rozšířit množinu sledovaných údajů,
musíte opět sáhnout do definice entit a jejich mapování. Takže
shrnuto, je to dost práce.</p>
<p>Co kdybych ale nemusel řešit již při sběru informací o
událostech, jaké údaje budu později potřebovat. 
</p>
<p>Pro tento účel by mně mohla dobře posloužit NoSQL databáze,
ve které nemusím striktně dodržovat strukturu dat. Až při
jejich použití si vybírám pouze ty, které mne v daný moment
zajímají.</p>
<p>Pro ukázku jsem použil CouchDB databázi instalovanou na stejném
stroji, na kterém vyvíjím.</p>
<h3 class="western">Implementace reakce na událost</h3>
<p>Informace o události budu zapisovat do databáze prostřednictvím
běžného REST rozhraní.</p>
<p>Moje implementace reakce na událost vypadá následovně:</p>
<pre class="western"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Service</font></font></font>
<font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@EnableAsync</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#9e880d">@Profile</font>(<font color="#067d17">&quot;listener-couchdb&quot;</font>)</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">CouchDBEventListener </font>{</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private static final </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Logger </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger </i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">LoggerFactory</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>getLogger</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">CouchDBEventListener</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">class</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private final </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">RestTemplate </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">restTemplate</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Value</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;${couchdb.url-base}&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">URI </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">resourceBase</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Value</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;${couchdb.username}&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">userName</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Value</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;${couchdb.password}&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">password</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">CouchDBEventListener</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Autowired </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">RestTemplateBuilder </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">restTemplateBuilder) {</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">restTemplate </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= restTemplateBuilder.build();</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Async</font></font></font></font>
<font color="#9e880d">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@EventListener</font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">handleEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">CustomEvent </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event) {</font></font></font>
<font color="#080808">        <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">UUID id </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">UUID</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>randomUUID</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">();</font></font></font>
<font color="#080808">        <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">URI path </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">resourceBase</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.resolve(</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">resourceBase</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getPath() + </font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;/&quot; </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">+ </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">id</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">        <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ResponseEntity</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">CouchDBRestResponse</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&gt; </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">restTemplate</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.exchange(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">path</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">HttpMethod</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>PUT</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">HttpEntity&lt;&gt;(event, createHeaders(</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">userName</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">password</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)), </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">CouchDBRestResponse</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">class</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">if </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getStatusCode().is2xxSuccessful())</font></font></font>
<font color="#080808">            <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">if </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getBody() != </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">null</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">                <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.info(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Event stored to CouchDB: id={} rev={}&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getBody().getId(), </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getBody().getRev());</font></font></font>
<font color="#080808">            <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">else</font></font></font></font>
<font color="#080808"><font color="#0033b3">                </font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.info(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Event stored to CouchDB with no response object&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">else</font></font></font></font>
<font color="#080808"><font color="#0033b3">            </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">if </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getBody() != </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">null</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">                <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.info(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;FAILED: error={}, reason={}&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getBody().getError(), </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">response</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getBody().getReason());</font></font></font>
<font color="#080808">            <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">else</font></font></font></font>
<font color="#080808"><font color="#0033b3">                </font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.info(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;FAILED with no response object&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">HttpHeaders </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">createHeaders</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">username, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">password) {</font></font></font>
<font color="#080808">        <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">HttpHeaders headers </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">HttpHeaders();</font></font></font>
<font color="#080808">        <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String auth </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= username + </font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;:&quot; </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">+ password;</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">byte</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">[] </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">encodedAuth </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Base64</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>encodeBase64</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">auth</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.getBytes(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">StandardCharsets</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>US_ASCII</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">));</font></font></font>
<font color="#080808">        <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">headers</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.set(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Authorization&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Basic &quot; </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">+ </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">encodedAuth</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">));</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">headers</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Opět se jedná o asynchronně volanou metodu, neboť předpokládám,
že zápis dokumentu do databáze přes REST rozhraní přece jen
nějaký čas zabere.</p>
<p>Jedná se o metodu, která bude spuštěna pro každou událost
odvozenou od třídy <b>CustomEvent</b>. Pokud tedy do budoucna
přidám nějakou událost od ní zděděnou, bude tato událost
automaticky zahrnuta do zápisu.</p>
<p>Parametry pro připojení na databázi mám načtené ze
specifického konfiguračního souboru pro daný profil.</p>
<p>Navíc musí mít každý dokument v databázi unikátní ID,
proto jsem použil generované UUID.</p>
<p>Pro vyvolání REST rozhraní použiji instanci RestTemplate
poskytovanou frameworkem.</p>
<p>V případě že komunikuji s REST rozhraním CouchDB pro operaci
zápisu JSON dokumentu, bude výsledkem opět JSON objekt. Abych mohl
tento výsledek načíst, připravil jsem si třídu obsahující
atributy vrácené při úspěchu i chybě: 
</p>
<pre class="western"><font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">CouchDBRestResponse </font>{</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Boolean </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ok</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">UUID </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">id</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">rev</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">error</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">reason</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Boolean </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getOk</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ok</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">setOk</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Boolean </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ok) { </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ok </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= ok; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">UUID </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getId</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">id</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">setId</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">UUID </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">id) { </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">id </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= id; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getRev</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() { </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">rev</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">setRev</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">rev) { </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">rev </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= rev; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getError</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() { </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">error</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">setError</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">error) { </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">error </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= error; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getReason</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() { </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">reason</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">setReason</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">reason) { </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">reason </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= reason; }</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
A nyní mám již všechno potřebné, abych si mohl vše vyzkoušet.</p>
<h3 class="western">Jak si to mohu zkusit</h3>
<p>Nejdříve je dobré si ověřit, že mně funguje CouchDB server,
a to nejjednodušeji takto:</p>
<pre class="western">[raska@fedora ~]$ curl -s http://localhost:5984 | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;couchdb&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;Welcome&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;version&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;3.2.1&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;git_sha&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;244d428af&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;uuid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2e2af3d6e57ed59cd03de3e5020ba617&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;features&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: [</b></font>
    <font color="#26a269"><font size="1" style="font-size: 8pt">&quot;access-ready&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#26a269"><font size="1" style="font-size: 8pt">&quot;partitioned&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#26a269"><font size="1" style="font-size: 8pt">&quot;pluggable-storage-engines&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#26a269"><font size="1" style="font-size: 8pt">&quot;reshard&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#26a269"><font size="1" style="font-size: 8pt">&quot;scheduler&quot;</font></font>
  <font size="1" style="font-size: 8pt"><b>],</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;vendor&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;name&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;The Apache Software Foundation&quot;</font></font>
  <font size="1" style="font-size: 8pt"><b>}</b></font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><p>
Nyní si ještě potřebuji vytvořit databázi <b>events</b> pro
ukládání dokumentů (jméno je zahrnuto do URL v konfiguračním
parametru <i>couchdb.url-base</i>).</p>
<pre class="western">[raska@fedora ~]$ curl -s -X PUT http://admin:admin@localhost:5984/events | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ok&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">true</font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><p>
Nyní si již můžu spustit svoji aplikaci s profilem
listener-couchdb:</p>
<pre class="western" style="margin-bottom: 0.2in">[raska@fedora jv-application-events-guide]$ java -jar target/application-events-guide-1.0.0.jar --spring.profiles.active=listener-couchdb</pre><p>
A v jiném terminálu si spustit dvě služby:</p>
<pre class="western">[raska@fedora ~]$ jo -p nid=local:node02 name=node02 tid=${RANDOM} value=20 | curl -s -X GET --data-binary @- -H &quot;Content-type: application/json&quot; http://localhost:8080/rest/serviceA | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;nid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;local:node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;name&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;12879&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ts&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2021-12-13T18:57:32.215+00:00&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;code&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;OK&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;result&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">26</font>
<font size="1" style="font-size: 8pt"><b>}</b></font>
[raska@fedora ~]$ jo -p nid=local:node03 name=node03 tid=$RANDOM text=blablabla | curl -s -X GET --data-binary @- -H &quot;Content-type: application/json&quot; http://localhost:8080/rest/serviceB | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;nid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;local:node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;name&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;10430&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ts&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2021-12-13T18:57:42.043+00:00&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;code&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;OK&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;text&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;text length: 9&quot;</font></font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><p>
Tak, a teď bych se mohl podívat, jaké dokumenty mám v databázi
events:</p>
<pre class="western">[raska@fedora ~]$ curl -s http://admin:admin@localhost:5984/events/_all_docs | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;total_rows&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">4</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;offset&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">0</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;rows&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: [</b></font>
    <font size="1" style="font-size: 8pt"><b>{</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2ded6704-35ea-49d5-9188-f969b6931185&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;key&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2ded6704-35ea-49d5-9188-f969b6931185&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;value&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
        <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;rev&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;1-9457044ad6d8efc78b33f1fc54067e5f&quot;</font></font>
      <font size="1" style="font-size: 8pt"><b>}</b></font>
    <font size="1" style="font-size: 8pt"><b>},</b></font>
    <font size="1" style="font-size: 8pt"><b>{</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;63410079-bc10-49c3-a6b8-cd596487ff5f&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;key&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;63410079-bc10-49c3-a6b8-cd596487ff5f&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;value&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
        <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;rev&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;1-91cc33fc84fae21b2e9f400f28730a2f&quot;</font></font>
      <font size="1" style="font-size: 8pt"><b>}</b></font>
    <font size="1" style="font-size: 8pt"><b>},</b></font>
    <font size="1" style="font-size: 8pt"><b>{</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;77b460e0-5dd5-4b3c-9b75-9bb30c240ad0&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;key&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;77b460e0-5dd5-4b3c-9b75-9bb30c240ad0&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;value&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
        <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;rev&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;1-ec9104b1f577555eef97ca08a3f348a1&quot;</font></font>
      <font size="1" style="font-size: 8pt"><b>}</b></font>
    <font size="1" style="font-size: 8pt"><b>},</b></font>
    <font size="1" style="font-size: 8pt"><b>{</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;8fa0b94c-fb8f-499a-9751-f62380fde6e9&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;key&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;8fa0b94c-fb8f-499a-9751-f62380fde6e9&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;value&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
        <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;rev&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;1-3a5ddbf558cf12047d8c873d7b1a1ba2&quot;</font></font>
      <font size="1" style="font-size: 8pt"><b>}</b></font>
    <font size="1" style="font-size: 8pt"><b>}</b></font>
  <font size="1" style="font-size: 8pt"><b>]</b></font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><p>
Podle očekávání mám v databázi čtyři dokumenty, pro každou
provedenou službu dva.</p>
<p>Mohu se podívat na obsah nějakého dokumentu:</p>
<pre class="western">[raska@fedora ~]$ curl -s http://admin:admin@localhost:5984/events/8fa0b94c-fb8f-499a-9751-f62380fde6e9 | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;_id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;8fa0b94c-fb8f-499a-9751-f62380fde6e9&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;_rev&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;1-3a5ddbf558cf12047d8c873d7b1a1ba2&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;source&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;instanceName&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;Provider B&quot;</font></font>
  <font size="1" style="font-size: 8pt"><b>},</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;timestamp&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1639421862042</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;phase&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;ASKED&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;request&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;nid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;local:node03&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;name&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;node03&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;10430&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ts&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2021-12-13T18:57:42.042+00:00&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;text&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;blablabla&quot;</font></font>
  <font size="1" style="font-size: 8pt"><b>},</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;response&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#171421"><font size="1" style="font-size: 8pt"><b>null</b></font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;event&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ASKED&quot;</font></font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><p>
Nebo si vybrat jen některé atributy z každého dokumentu bez
ohledu na jeho strukturu:</p>
<pre class="western">[raska@fedora ~]$ curl -s -X POST -d @- -H 'Content-Type:application/json' 'http://admin:admin@localhost:5984/events/_find' &lt;&lt;! | jq .
&gt; {
  &quot;selector&quot;: {},
  &quot;fields&quot;: [
    &quot;_id&quot;,
    &quot;timestamp&quot;,
    &quot;event&quot;,
    &quot;request.tid&quot;
  ]
}
!
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;docs&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: [</b></font>
    <font size="1" style="font-size: 8pt"><b>{</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;_id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2ded6704-35ea-49d5-9188-f969b6931185&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;timestamp&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1639421852211</font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;event&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ASKED&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;request&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
        <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;12879&quot;</font></font>
      <font size="1" style="font-size: 8pt"><b>}</b></font>
    <font size="1" style="font-size: 8pt"><b>},</b></font>
    <font size="1" style="font-size: 8pt"><b>{</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;_id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;63410079-bc10-49c3-a6b8-cd596487ff5f&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;timestamp&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1639421862045</font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;event&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ANSWERED&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;request&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
        <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;10430&quot;</font></font>
      <font size="1" style="font-size: 8pt"><b>}</b></font>
    <font size="1" style="font-size: 8pt"><b>},</b></font>
    <font size="1" style="font-size: 8pt"><b>{</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;_id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;77b460e0-5dd5-4b3c-9b75-9bb30c240ad0&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;timestamp&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1639421852215</font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;event&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ANSWERED&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;request&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
        <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;12879&quot;</font></font>
      <font size="1" style="font-size: 8pt"><b>}</b></font>
    <font size="1" style="font-size: 8pt"><b>},</b></font>
    <font size="1" style="font-size: 8pt"><b>{</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;_id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;8fa0b94c-fb8f-499a-9751-f62380fde6e9&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;timestamp&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1639421862042</font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;event&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ASKED&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;request&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
        <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;10430&quot;</font></font>
      <font size="1" style="font-size: 8pt"><b>}</b></font>
    <font size="1" style="font-size: 8pt"><b>}</b></font>
  <font size="1" style="font-size: 8pt"><b>],</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;bookmark&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;g1AAAAB4eJzLYWBgYMpgSmHgKy5JLCrJTq2MT8lPzkzJBYqrWKQlGiRZmiTrpiVZpOmaWFom6lqamxrqppkZGVsYpKWkmqVagvRywPQSrSsLAKBcIIU&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;warning&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;No matching index found, create an index to optimize query time.&quot;</font></font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><h3 class="western">
Komentář na závěr kapitoly</h3>
<p>Na první pohled může tento postup být velice zajímavý, neboť
můžete dodatečně doplňovat sledované události, které se
jakoby samy od sebe začnou zapisovat do databáze. 
</p>
<p>Je to ale dvousečná zbraň. S událostí mohou putovat i citlivé
údaje, které nechcete, aby se objevovaly v nějaké externí
databázi (v mém případě jsou to výsledky provedení služeb,
což sice moc citlivé není, ale asi to v auditních záznamech
nechceme).</p>
<p>A nemusí se jednat pouze o citlivé údaje. Mohou to být také
údaje, které mají pouze dočasný význam a v databázi by nám
jen zbytečně zabíraly místo.</p>
<p><u>Berte prosím předchozí řádky jako ukázku, která nemusí
za každé situace vyhovovat.</u></p>
<h2 class="western">Reakce na události Spring frameworku</h2>
<table width="100%" cellpadding="4" cellspacing="0" style="background: transparent; page-break-inside: auto">
	<col width="39*"/>

	<col width="217*"/>

	<tr style="background: transparent" valign="top">
		<td width="15%" bgcolor="#dddddd" style="background: #dddddd; border-top: 1px solid #000000; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0.02in; padding-bottom: 0.02in; padding-left: 0.02in; padding-right: 0in"><p align="right">
			<font size="2" style="font-size: 10pt"><b>Třída: </b></font>
			</p>
		</td>
		<td width="85%" style="background: transparent; border: 1px solid #000000; padding: 0.04in"><p align="left">
			<b>ApplicationEventListener</b></p>
		</td>
	</tr>
	<tr style="background: transparent" valign="top">
		<td width="15%" bgcolor="#dddddd" style="background: #dddddd; border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0in; padding-bottom: 0.02in; padding-left: 0.02in; padding-right: 0in"><p align="right">
			<font size="2" style="font-size: 10pt"><b>Profil: </b></font>
			</p>
		</td>
		<td width="85%" style="background: transparent; border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0.04in"><p align="left">
			<b>listener-application</b></p>
		</td>
	</tr>
</table>
<p>Aplikační události nemusí vytvářet pouze vaše aplikace.
Stejně tak dělá Spring framework sám o svém běhu. Jejich
přehled najdete v dokumentaci pod kapitolou <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.spring-application.application-events-and-listeners">Application
Events and Listeners</a>. 
</p>
<p>Reaguji na jejich výskyt úplně stejně, jako bych reagoval na
své vlastní události. 
</p>
<p>Udělal jsem tedy metodu, která mně bude sledovat start a
zastavení aplikace, a bude o nich dělat auditní záznam (zápisy o
událostech budu dělat do CouchDB). Abych mohl využít
funkcionality dříve vytvořené pro zápis do CouchDB, publikuji
při startu a ukončení aplikace vlastní událost typu
<b>SupervisionEvent</b> (ta je potomkem CustomEvent).</p>
<pre class="western"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Service</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#9e880d">@Profile</font>(<font color="#067d17">&quot;listener-application&quot;</font>)</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">ApplicationEventListener </font>{</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private static final </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Logger </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger </i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">LoggerFactory</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>getLogger</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicationEventListener</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">class</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@EventListener</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(classes = {</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicationReadyEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">class</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ContextClosedEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">class</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">})</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicationEvent </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">handleEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicationEvent </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event) {</font></font></font>

<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">if </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(event </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">instanceof </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicationReadyEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">            <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">SupervisionEvent(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">SupervisionEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Severity</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>INFO</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Application started&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">else if </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(event </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">instanceof </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ContextClosedEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">            <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">SupervisionEvent(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">SupervisionEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Severity</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>INFO</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Application stopped&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">else</font></font></font></font>
<font color="#080808"><font color="#0033b3">            </font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.error(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;ApplicationEvent Class {} is not supported!&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, event.getClass().getSimpleName());</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return null</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Všimněte si prosím několika odlišností od předchozích
příkladů:</p>
<ol>
	<li><p>U anotace <i>@EventListener</i> jsou explicitně stanoveny
	třídy událostí, na které se má reagovat parametrem <b>classes</b>.</p>
	<li><p>Díky předchozímu bodu pak mohu mít jako parametr metody
	třídu ApplicantEvent, což je společný předek pro všechny
	události bez rozdílu. To, jaké události se skutečně dostanou
	do zpracování metody, závisí na anotaci.</p>
	<li><p>Metoda vrací objekt typu ApplicationEvent. To je další
	možný způsob, jak publikovat nějakou událost. V mám případě
	při startu a ukončení aplikace vytvořím novou instanci události
	SupervisionEvent, kterou publikuji tím, že ji vrátím jako
	výsledek metody.</p>
</ol>
<h3 class="western">Jak si to mohu zkusit</h3>
<p>Ujistěte se, že vám běží CouchDB a že máte vytvořenu
databázi <b>events</b>, třeba takto:</p>
<pre class="western">[raska@fedora ~]$ curl -s http://admin:admin@localhost:5984/events | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;db_name&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;events&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;purge_seq&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;0-g1AAAABXeJzLYWBgYMpgTmEQTM4vTc5ISXIwNDLXMwBCwxyQVB4LkGRoAFL_gSArkQGP2kSGpHqIoiwAtOgYRA&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;update_seq&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;4-g1AAAACbeJzLYWBgYMpgTmEQTM4vTc5ISXIwNDLXMwBCwxyQVB4LkGRoAFL_gSArgzmRKRcowG5maWphnGiJTR8e0xIZkupRjEk2Sk4yTDXBpiELANdPKFc&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;sizes&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;file&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">33160</font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;external&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1262</font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;active&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">2253</font>
  <font size="1" style="font-size: 8pt"><b>},</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;props&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {},</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;doc_del_count&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">0</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;doc_count&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">4</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;disk_format_version&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">8</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;compact_running&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">false</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;cluster&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;q&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">2</font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;n&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1</font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;w&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1</font><font size="1" style="font-size: 8pt"><b>,</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;r&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1</font>
  <font size="1" style="font-size: 8pt"><b>},</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;instance_start_time&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;0&quot;</font></font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><p>
V databázi mám od předchozího testování nějaké dokumenty.
Pokud chci mít čistou databázi, nejjednodušší cesta je smazat
původní a vytvořit novou, třeba takto:</p>
<pre class="western">[raska@fedora ~]$ curl -s -X DELETE http://admin:admin@localhost:5984/events | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ok&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">true</font>
<font size="1" style="font-size: 8pt"><b>}</b></font>
[raska@fedora ~]$ curl -s -X PUT http://admin:admin@localhost:5984/events | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ok&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">true</font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><p>
Opět nejdříve spustit aplikaci, tentokrát s profily
listener-application a listener-couchdb.</p>
<pre class="western" style="margin-bottom: 0.2in">[raska@fedora jv-application-events-guide]$ java -jar target/application-events-guide-1.0.0.jar --spring.profiles.active=listener-application,listener-couchdb</pre><p>
Dále si zavolám nějakou službu a následně aplikaci ukončím.</p>
<pre class="western">[raska@fedora ~]$ jo -p nid=local:node02 name=node02 tid=${RANDOM} value=20 | curl -s -X GET --data-binary @- -H &quot;Content-type: application/json&quot; http://localhost:8080/rest/serviceA | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;nid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;local:node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;name&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;node01&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;9702&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;ts&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;2021-12-13T10:00:54.017+00:00&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;code&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;OK&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;result&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">27</font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><p>
A nyní si můžu zkontrolovat, jaké události se mně objevily v
databázi:</p>
<pre class="western">[raska@fedora ~]$ jo selector=&quot;{}&quot; fields=&quot;$(jo -a _id timestamp event request.tid)&quot; | curl -s -X POST -d @- -H 'Content-Type:application/json' 'http://admin:admin@localhost:5984/events/_find' | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;docs&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: [</b></font>
    <font size="1" style="font-size: 8pt"><b>{</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;_id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;03605b94-0f0d-48d1-9b04-2a8cd6802a24&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;timestamp&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1639476054017</font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;event&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ASKED&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;request&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
        <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;9702&quot;</font></font>
      <font size="1" style="font-size: 8pt"><b>}</b></font>
    <font size="1" style="font-size: 8pt"><b>},</b></font>
    <font size="1" style="font-size: 8pt"><b>{</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;_id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;6c3aeaf3-2f9a-4e22-9866-71b379cde347&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;timestamp&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1639476054017</font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;event&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ANSWERED&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;request&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
        <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;tid&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;9702&quot;</font></font>
      <font size="1" style="font-size: 8pt"><b>}</b></font>
    <font size="1" style="font-size: 8pt"><b>},</b></font>
    <font size="1" style="font-size: 8pt"><b>{</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;_id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;86a531d2-eb0f-42a9-b821-6cf97e1fb71d&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;timestamp&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1639476058700</font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;event&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.SupervisionEvent.INFO&quot;</font></font>
    <font size="1" style="font-size: 8pt"><b>},</b></font>
    <font size="1" style="font-size: 8pt"><b>{</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;_id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;c44174aa-7317-4cef-8948-73a6b3882a2e&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;timestamp&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1639475992149</font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;event&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.SupervisionEvent.INFO&quot;</font></font>
    <font size="1" style="font-size: 8pt"><b>}</b></font>
  <font size="1" style="font-size: 8pt"><b>],</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;bookmark&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;g1AAAAB4eJzLYWBgYMpgSmHgKy5JLCrJTq2MT8lPzkzJBYqrJJuYGJqbJCbqmhsbmuuaJKem6VpYmlgAuYlmScYWFkaJRqkgvRwwvUTrygIAW6IfOQ&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;warning&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;No matching index found, create an index to optimize query time.&quot;</font></font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><p>
Podle očekávání jsou to události o provedení služby a také o
startu a zastavení aplikace.</p>
<p>Mohu se podívat na detail nějaké události:</p>
<pre class="western">[raska@fedora ~]$ curl -s http://admin:admin@localhost:5984/events/c44174aa-7317-4cef-8948-73a6b3882a2e | jq .
<font size="1" style="font-size: 8pt"><b>{</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;_id&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;c44174aa-7317-4cef-8948-73a6b3882a2e&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;_rev&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;1-2b8637fe67cabe835c87b5d9187d3fd1&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;source&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {},</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;timestamp&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1639475992149</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;severity&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;INFO&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;message&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;Application started&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;event&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.SupervisionEvent.INFO&quot;</font></font>
<font size="1" style="font-size: 8pt"><b>}</b></font></pre><h2 class="western">
Dočasně uložené události</h2>
<table width="100%" cellpadding="4" cellspacing="0" style="background: transparent; page-break-inside: auto">
	<col width="39*"/>

	<col width="217*"/>

	<tr style="background: transparent" valign="top">
		<td width="15%" bgcolor="#dddddd" style="background: #dddddd; border-top: 1px solid #000000; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0.02in; padding-bottom: 0.02in; padding-left: 0.02in; padding-right: 0in"><p align="right">
			<font size="2" style="font-size: 10pt"><b>Třída: </b></font>
			</p>
		</td>
		<td width="85%" style="background: transparent; border: 1px solid #000000; padding: 0.04in"><p align="left">
			<b>DelayedEventListener</b></p>
		</td>
	</tr>
	<tr style="background: transparent" valign="top">
		<td width="15%" bgcolor="#dddddd" style="background: #dddddd; border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: none; padding-top: 0in; padding-bottom: 0.02in; padding-left: 0.02in; padding-right: 0in"><p align="right">
			<font size="2" style="font-size: 10pt"><b>Profil: </b></font>
			</p>
		</td>
		<td width="85%" style="background: transparent; border-top: none; border-bottom: 1px solid #000000; border-left: 1px solid #000000; border-right: 1px solid #000000; padding-top: 0in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0.04in"><p align="left">
			<b>listener-delayed</b></p>
		</td>
	</tr>
</table>
<p>V některých případech nepotřebuji dlouhodobě ukládat
informace o událostech v aplikaci, ale hodilo by se mně, abych je
měl k dispozici po nějakou omezenou dobu, a jen za běhu aplikace. 
</p>
<p>Tak například, pokud bych chtěl sledovat frekvenci výskytu
nějaké události a při překročení nějaké meze být
informován. Nebo naopak bych mohl chtít být upozorněn, že v
nějakém stanoveném období událost vůbec nenastala.</p>
<p>Jinak řešeno, pokud vznikne událost, krátkodobě si jí
podržím jako instanci v aplikaci. Po uplynutí stanovené doby může
být instance zahozena.</p>
<p>Pro tento účel využiji <b>DelayQueue</b> z balíku
<i>java.util.concurrent</i>, což je implementace fronty, která vydá
objekty k vyzvednutí po uplynutí stanoveného času pro každý
vložený objekt.</p>
<h3 class="western">Událost s dobou životnosti</h3>
<p>Abych mohl využít implementaci fronty DelayQueue, potřebuji,
aby události implementovaly rozhraní <b>Delayed</b>. 
</p>
<p>Vytvořil jsem si tedy parametrickou třídu implementující toto
rozhraní. Parametrem pak bude třída odvozená od mojí kořenové
události, tedy <i>CustomEvent</i>.</p>
<pre class="western"><font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">DelayedCustomEvent</font>&lt;<font color="#007e8a">T </font><font color="#0033b3">extends </font><font color="#000000">CustomEvent</font>&gt; <font color="#0033b3">implements </font><font color="#000000">Delayed </font>{</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private final </font></font></font><font color="#007e8a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">T </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private final long </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">startTime</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayedCustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#007e8a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">T </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event, </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">long </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">startTime) {</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= event;</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">startTime </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">System</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>currentTimeMillis</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() + startTime;</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Override</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public long </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getDelay</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">TimeUnit </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">timeUnit) {</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">timeUnit.convert(</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">startTime </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">- </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">System</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>currentTimeMillis</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(), </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">TimeUnit</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>MILLISECONDS</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Override</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public int </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">compareTo</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Delayed </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">delayed) {</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Long</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>valueOf</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">startTime </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">- ((</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayedCustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;? </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">extends </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">CustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&gt;) delayed).</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">startTime</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">).intValue();</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#007e8a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">T </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() { </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">; }</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public long </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">getStartTime</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() {</font></font> <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">startTime</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font> <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Instance DelayedCustomEvent tedy zahrnuje instanci samotné události
a časový limit v milisekundách, po který je instance platná.</p>
<h3 class="western">Komponenta Fronta událostí</h3>
<p>Komponenta Fronta událostí je vytvořena v
<b>component/EventQueueComponent</b>.</p>
<pre class="western"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Configuration</font></font></font>
<font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@EnableAsync</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#9e880d">@Profile</font>(<font color="#067d17">&quot;listener-delayed&quot;</font>)</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">EventQueueComponent </font>{</font></font></font>

<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private static final </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Logger </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger </i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">LoggerFactory</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>getLogger</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">EventQueueComponent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">class</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Bean</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayedCustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;? </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">extends </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">CustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&gt;&gt; </font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() {</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayQueue&lt;&gt;();</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@SuppressWarnings</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;InfiniteLoopStatement&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Async</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">runEventConsumer</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Autowired </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayedCustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;? </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">extends </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">CustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&gt;&gt; eventQueue) {</font></font></font>
<font color="#080808">        <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.info(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;*** EventQueue Cleaner started ***&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">while </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">true</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">) {</font></font></font>
<font color="#080808">            <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">try </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">{</font></font></font>
<font color="#080808">                <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventQueue.take();</font></font></font>
<font color="#080808">            <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">} </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">catch </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">InterruptedException </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ignored) { }</font></font></font>
<font color="#080808">        <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
V podstatě se jedná o komponentu, která vytváří instanci
odvozenou z DelayQueue v kontextu Spring.</p>
<p>Navíc je zde asynchronně spouštěná metoda <b>runEventConsumer()</b>.
Jejím úkolem je vyjmout z fronty ty instance, jejíchž časový
limit vypršel.</p>
<p>Tato metoda je spuštěná při startu aplikace:</p>
<pre class="western" style="background: #ffffff"><font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Bean</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicationRunner </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">applicationRunner</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Nullable </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">EventQueueComponent </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventQueueComponent, </font></font><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Nullable </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayedCustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;? </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">extends </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">CustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&gt;&gt; eventQueue) {</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">args -&gt; {</font></font></font>
<font color="#080808">            <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>logger</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.info(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;*** Hello World, greetings from Dwarf ***&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">            <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">if </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#851691"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventQueueComponent </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">!= </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">null</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">                <font color="#851691"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventQueueComponent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.runEventConsumer(</font></font><font color="#851691"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">        <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">};</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Komponenta <i>EventQueueComponent</i> a fronta zpráv <i>EventQueue</i>
jsou injektovány do parametrů volání applicationRunner(). Pokud
není komponenta k dispozici, pak jsou parametry <i>null</i>, což
umožňuje anotace <i>@Nullable</i>.</p>
<h3 class="western">Zápis do fronty událostí</h3>
<p>Zápis událostí do fronty je jednoduchá podoba EventListener,
jak jsem jí již několikrát ukazoval:</p>
<pre class="western"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Service</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#9e880d">@Profile</font>(<font color="#067d17">&quot;listener-delayed&quot;</font>)</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">DelayedEventListener </font>{</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Value</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;${events.delay:5000}&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private long </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">delay</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Autowired </font></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayedCustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;? </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">extends </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">CustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&gt;&gt; </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@EventListener</font></font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">handleEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">CustomEvent </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">event) {</font></font></font>
<font color="#080808">        <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.put(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayedCustomEvent&lt;&gt;(event, </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">delay</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">));</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Z běžné události udělám DelayCustomEvent s nastavenou
životností podle parametru ve specifickém konfiguračním souboru
profilu <b>application-listener-delayed.yaml</b>:</p>
<pre class="western"><font color="#080808"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt"><font color="#0033b3">events</font>:</font></font></font>
<font color="#080808">  <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">delay</font></font></font><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">: 60000</font></font></font></pre><p>
Tu pak vložím do komponenty EventQueue, instance opět injektována
z kontextu.</p>
<h3 class="western">Náhled do fronty událostí</h3>
<p>Abych se mohl podívat, co mám aktuálně ve frontě zpráv,
vytvořil jsem si dvě jednoduché REST služby.</p>
<p>Vše je v <b>rest/EventsController</b>:</p>
<pre class="western"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@RestController</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#9e880d">@Profile</font>(<font color="#067d17">&quot;listener-delayed&quot;</font>)</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">EventsController </font>{</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Autowired </font></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayedCustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;? </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">extends </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">CustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&gt;&gt; </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@RequestMapping</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(value = </font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;/events/all&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, method = {</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">RequestMethod</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>GET</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">RequestMethod</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>POST</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">})</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayedCustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;? </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">extends </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">CustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&gt;&gt; </font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventsAll</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() {</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@RequestMapping</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(value = </font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;/events/histogram&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, method = {</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">RequestMethod</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>GET</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">RequestMethod</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>POST</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">})</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public long</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">[] </font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventsHistogram</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() {</font></font></font>
<font color="#080808">        <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Frequency frequency </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Frequency();</font></font></font>
<font color="#080808">        <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.forEach(event -&gt; </font></font><font color="#851691"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">frequency</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.addValue(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Long</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>valueOf</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Math</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>max</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">System</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>currentTimeMillis</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() - event.getEvent().getTimestamp(), </font></font><font color="#1750eb"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">0</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">) / </font></font><font color="#1750eb"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">10000</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">).intValue()));</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">return </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">IntStream</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>range</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#1750eb"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">0</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#1750eb"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">6</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">).asLongStream().map(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">frequency</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">::getCount).toArray();</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Jsou zde dvě služby:</p>
<ul>
	<li><p style="font-variant: normal; font-style: normal"><b>events/all</b>
	– seznam všech událostí ve frontě jako pole JSON objektů</p>
	<li><p style="font-variant: normal; font-style: normal"><b>events/histogram</b>
	– vrátí mně histogram výskytu všech událostí v intervalech
	po 10 sekundách</p>
</ul>
<h3 class="western">Kontrola frekvence výskytu událostí</h3>
<p>To, že se mně nějaká událost objevuje neobvykle často (nebo
naopak vůbec) může být signálem, že se v aplikaci děje něco
nekalého. Může to být neobvyklé až nepřátelské chování
uživatelů, nebo také nějaká aplikační či konfigurační
chyba. 
</p>
<p>Co to znamená „neobvykle často“ si musíte stanovit vždy
sami, a závisí to na typu aplikace a způsobu jejího použití. K
nějakému smysluplnému číslu se můžete dostat i vyhodnocením
starších záznamů o událostech. To ale bude vyžadovat, abyste si
je po nějakou dobu ukládali do nějakého trvalého úložiště.</p>
<p>V mém příkladu nic takového dělat nebudu, prostě jsem si
stanovil, že „neobvykle často“ bude v mém případě více jak
10 událostí za 30 sekund.</p>
<p>Takto vypadá moje implementace komponenty kontrolující obsah
fronty události, <b>component/EventChecker</b>:</p>
<pre class="western"><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Service</font></font></font>
<font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@EnableScheduling</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#9e880d">@Profile</font>(<font color="#067d17">&quot;event-checker&quot;</font>)</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><font color="#0033b3">public class </font><font color="#000000">EventChecker </font>{</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Autowired </font></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicationEventPublisher </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">publisher</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Autowired @Nullable </font></font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">DelayedCustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&lt;? </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">extends </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">CustomEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&gt;&gt; </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Value</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;${event.checker.interval:10000}&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private int </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">interval</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>
<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Value</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;${event.checker.threshold:10}&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">private int </font></font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">threshold</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">;</font></font></font>

<font color="#080808">    <font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Async</font></font></font></font>
<font color="#080808"><font color="#9e880d">    </font><font color="#9e880d"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">@Scheduled</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(fixedRateString = </font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;${event.checker.scheduled:5000}&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">public void </font></font></font><font color="#00627a"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">check</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() {</font></font></font>
<font color="#080808">        <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">if </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventQueue </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">!= </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">null</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">) {</font></font></font>
<font color="#080808">            <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">long </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventCount </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventQueue</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.stream()</font></font></font>
<font color="#080808">                    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.filter(event -&gt; </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Long</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>valueOf</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Math</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>max</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">System</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>currentTimeMillis</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">() - event.getEvent().getTimestamp(), </font></font><font color="#1750eb"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">0</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)).intValue() &lt;= </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">interval</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">                    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.filter(event -&gt; event.getEvent() </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">instanceof </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ProviderEvent </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">|| event.getEvent() </font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">instanceof </font></font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">ApplicantEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">)</font></font></font>
<font color="#080808">                    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.count();</font></font></font>
<font color="#080808">            <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">if </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">eventCount </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&gt;= </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">threshold</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">) {</font></font></font>
<font color="#080808">                <font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">String message </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">= </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">MessageFormat</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>format</i></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">(</font></font><font color="#067d17"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">&quot;Events Count exceeded specified threshold {0} in last {1} milliseconds!&quot;</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">threshold</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">interval</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">);</font></font></font>
<font color="#080808">                <font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">publisher</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.publishEvent(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">new </font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">SupervisionEvent(</font></font><font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">this</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">SupervisionEvent</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">Severity</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">.</font></font><font color="#871094"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt"><i>WARNING</i></font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">, </font></font><font color="#000000"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">message</font></font></font><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">));</font></font></font>
<font color="#080808">            <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">        <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808">    <font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font>
<font color="#080808"><font face="JetBrains Mono, monospace"><font size="1" style="font-size: 8pt">}</font></font></font></pre><p>
Parametry pro provedení jsou definovány v konfiguračním souboru
profilu <b>application-event-checker.yaml</b>:</p>
<pre class="western"><font color="#080808"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt"><font color="#0033b3">event</font>:</font></font></font>
<font color="#080808">  <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">checker</font></font></font><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">:</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">interval</font></font></font><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">: 30000</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">threshold</font></font></font><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">: 10</font></font></font>
<font color="#080808">    <font color="#0033b3"><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">scheduled</font></font></font><font face="JetBrains Mono, monospace"><font size="2" style="font-size: 9pt">: 10000</font></font></font></pre><p>
Metoda je opakovaně spouštěna časovačem s intervalem 10 sekund.
Zkontroluje počet událostí typu <i>ProviderEvent</i> nebo
<i>ApplicantEvent</i> s dobou trvání v požadovaném intervalu. A
pokud počet událostí přesáhne stanovenou hranici, vytvoří
novou událost typu <i>SupervisionEvent</i>.</p>
<h3 class="western">Jak si to mohu zkusit</h3>
<p>Nejdříve se podívám na funkci <b>EventQueue</b> jako takové. 
</p>
<p>Takže si spustím aplikaci s profilem <b>listener-delayed:</b></p>
<pre class="western" style="margin-bottom: 0.2in">[raska@fedora jv-application-events-guide]$ java -jar target/application-events-guide-1.0.0.jar --spring.profiles.active=listener-delayed</pre><p>
Zkusím vyvolat několik požadavků na službu (to již nebudu
ukazovat, příkladů najdete v předchozích kapitolách dostatek).</p>
<p>A nyní zkusím zkontrolovat, kolik událostí mám ve frontě a
jejich histogram:</p>
<pre class="western"><font size="1" style="font-size: 8pt">[raska@fedora ~]$ <font size="2" style="font-size: 10pt">curl -s http://localhost:8080/events/all | jq '. | length'</font></font>
<font size="1" style="font-size: 8pt">16</font>
<font size="1" style="font-size: 8pt">[raska@fedora ~]$ <font size="2" style="font-size: 10pt">curl -s http://localhost:8080/events/histogram | jq .</font></font>
<font size="1" style="font-size: 8pt"><b>[</b></font>
  <font size="1" style="font-size: 8pt">2</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font size="1" style="font-size: 8pt">0</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font size="1" style="font-size: 8pt">0</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font size="1" style="font-size: 8pt">12</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font size="1" style="font-size: 8pt">2</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font size="1" style="font-size: 8pt">0</font>
<font size="1" style="font-size: 8pt"><b>]</b></font></pre><p>
Po uplynutí jedné minuty histogram vypadá takto (fronta je
prázdná): 
</p>
<pre class="western"><font size="1" style="font-size: 8pt">[raska@fedora ~]$ <font size="2" style="font-size: 10pt">curl -s http://localhost:8080/events/histogram | jq .</font></font>
<font size="1" style="font-size: 8pt"><b>[</b></font>
  <font size="1" style="font-size: 8pt">0</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font size="1" style="font-size: 8pt">0</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font size="1" style="font-size: 8pt">0</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font size="1" style="font-size: 8pt">0</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font size="1" style="font-size: 8pt">0</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font size="1" style="font-size: 8pt">0</font>
<font size="1" style="font-size: 8pt"><b>]</b></font></pre><p>
A nyní si můžu vyzkoušet kontrolu počtu událostí. Spustím
aplikaci s profily <b>listener-delayed</b> a <b>event-checker</b>:</p>
<pre class="western" style="margin-bottom: 0.2in">[raska@fedora jv-application-events-guide]$ java -jar target/application-events-guide-1.0.0.jar --spring.profiles.active=listener-delayed,event-checker</pre><p>
A dále pak opakovaně nějakou službu ...</p>
<p>Takto vypadá přehled typů událostí držených ve frontě:</p>
<pre class="western"><font size="1" style="font-size: 8pt">[raska@fedora ~]$ <font size="2" style="font-size: 10pt">curl -s http://localhost:8080/events/histogram | jq .</font></font>
<font size="1" style="font-size: 8pt"><b>[</b></font>
  <font size="1" style="font-size: 8pt">9</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font size="1" style="font-size: 8pt">11</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font size="1" style="font-size: 8pt">0</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font size="1" style="font-size: 8pt">0</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font size="1" style="font-size: 8pt">0</font><font size="1" style="font-size: 8pt"><b>,</b></font>
  <font size="1" style="font-size: 8pt">0</font>
<font size="1" style="font-size: 8pt"><b>]</b></font>
<font size="1" style="font-size: 8pt">[raska@fedora ~]$ <font size="2" style="font-size: 10pt">curl -s http://localhost:8080/events/all | jq '.[].event.event'</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ASKED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ANSWERED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ASKED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ANSWERED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ASKED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ANSWERED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ASKED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ANSWERED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ASKED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ANSWERED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.SupervisionEvent.WARNING&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ASKED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ANSWERED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ASKED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ANSWERED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ASKED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ANSWERED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ASKED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.ProviderEvent.ANSWERED&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.SupervisionEvent.WARNING&quot;</font></font>
<font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.SupervisionEvent.WARNING&quot;</font></font></pre><p>
Podle histogramu je vidět, že by mně měl checker zafungovat. A
taky že ano, ve frontě se objevily události typu <i>SupervisionEvent</i>.
</p>
<p>Jedna taková událost by mohla vypadat takto:</p>
<pre class="western">  <font size="1" style="font-size: 8pt"><b>{</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;event&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;source&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: {},</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;timestamp&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1639563915388</font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;severity&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;WARNING&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;message&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;Events Count exceeded specified threshold 10 in last 30,000 milliseconds!&quot;</font></font><font size="1" style="font-size: 8pt"><b>,</b></font>
      <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;event&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font color="#26a269"><font size="1" style="font-size: 8pt">&quot;CustomEvent.SupervisionEvent.WARNING&quot;</font></font>
    <font size="1" style="font-size: 8pt"><b>},</b></font>
    <font color="#12488b"><font size="1" style="font-size: 8pt"><b>&quot;startTime&quot;</b></font></font><font size="1" style="font-size: 8pt"><b>: </b></font><font size="1" style="font-size: 8pt">1639563975388</font>
  <font size="1" style="font-size: 8pt"><b>}</b></font></pre><p>
<br/>
<br/>

</p>
<p><br/>
<br/>

</p>
<div id="sdfootnote1"><p class="sdfootnote" style="margin-bottom: 0.2in">
	<a class="sdfootnotesym" name="sdfootnote1sym" href="#sdfootnote1anc">1</a>V
	případě, že bych chtěl službu využívat pouze v rámci jedné
	instance aplikace, pak by mně stačila jednoduchá injektáž
	rozhraní do klienta pomocí anotace @Autowired.</p>
</div>
</body>
</html>